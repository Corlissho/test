<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TWICE Â§™Á©∫Â∞ÑÊìäÈÅäÊà≤</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden; 
            background: #000;
            color: #fff;
        }
        
        canvas { 
            display: block; 
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
        }
        
        /* ÈÅäÊà≤‰ªãÈù¢ - Â∞ÑÊìäÈÅäÊà≤È¢®Ê†º */
        .game-ui {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        
        .score-board {
            position: absolute;
            top: 30px;
            left: 30px;
            font-size: 32px;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
        }
        
        .score-label {
            font-size: 20px;
            font-weight: 700;
            color: #6ee7b7;
            margin-bottom: 5px;
            letter-spacing: 2px;
        }
        
        .score-value {
            font-size: 48px;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 15px #6ee7b7;
        }
        
        .combo-board {
            position: absolute;
            top: 30px;
            right: 30px;
            text-align: right;
        }
        
        .combo-label {
            font-size: 20px;
            font-weight: 700;
            color: #6ee7b7;
            margin-bottom: 5px;
            letter-spacing: 2px;
        }
        
        .combo-value {
            font-size: 48px;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 15px #6ee7b7;
        }
        
        .life-board {
            position: absolute;
            top: 130px;
            left: 30px;
        }
        
        .life-label {
            font-size: 20px;
            font-weight: 700;
            color: #6ee7b7;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }
        
        .life-bar {
            width: 300px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .life-fill {
            height: 100%;
            background: linear-gradient(90deg, #6ee7b7, #3b82f6);
            width: 100%;
            transition: width 0.3s;
        }
        
        .life-value {
            position: absolute;
            right: 0;
            top: 0;
            font-size: 20px;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 0 5px #6ee7b7;
        }
        
        .weapon-board {
            position: absolute;
            top: 200px;
            left: 30px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            padding: 15px 20px;
            border: 2px solid rgba(110, 231, 183, 0.5);
            min-width: 250px;
        }
        
        .weapon-label {
            font-size: 18px;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 5px;
            letter-spacing: 1px;
        }
        
        .weapon-desc {
            font-size: 16px;
            color: #fff;
            opacity: 0.8;
        }
        
        .enemy-count {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }
        
        .enemy-label {
            font-size: 20px;
            font-weight: 700;
            color: #ef4444;
            margin-bottom: 5px;
            letter-spacing: 2px;
        }
        
        .enemy-value {
            font-size: 48px;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 15px #ef4444;
        }
        
        /* ÈñãÂßãÁï´Èù¢ */
        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #000428 0%, #004e92 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 1000;
        }
        
        .game-title {
            font-size: 64px;
            font-weight: 900;
            background: linear-gradient(90deg, #6ee7b7, #3b82f6, #ef4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
            text-shadow: 0 0 30px rgba(110, 231, 183, 0.5);
        }
        
        .difficulty-select {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .difficulty-btn {
            padding: 12px 30px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            font-weight: 600;
        }
        
        .difficulty-btn:hover {
            background: rgba(110, 231, 183, 0.2);
        }
        
        .difficulty-btn.active {
            background: rgba(110, 231, 183, 0.3);
            border-color: #6ee7b7;
            box-shadow: 0 0 15px rgba(110, 231, 183, 0.5);
        }
        
        .start-game-btn {
            background: linear-gradient(90deg, #6ee7b7, #3b82f6);
            border: none;
            color: white;
            padding: 20px 60px;
            font-size: 24px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 700;
            transition: transform 0.3s;
        }
        
        .start-game-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(110, 231, 183, 0.4);
        }
        
        /* ÂÄíÊï∏Ë®àÊôÇ */
        .countdown-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 998;
        }
        
        .countdown-number {
            font-size: 120px;
            font-weight: 900;
            color: #6ee7b7;
            text-shadow: 0 0 30px rgba(110, 231, 183, 0.8);
            margin-bottom: 20px;
        }
        
        .countdown-text {
            font-size: 36px;
            color: #fff;
            font-weight: 700;
        }
        
        /* ÈÅäÊà≤ÁµêÊùüÁï´Èù¢ */
        .gameover-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 997;
        }
        
        .gameover-title {
            font-size: 72px;
            font-weight: 900;
            color: #6ee7b7;
            margin-bottom: 30px;
            text-shadow: 0 0 20px rgba(110, 231, 183, 0.8);
        }
        
        .gameover-stats {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            min-width: 400px;
            margin-bottom: 40px;
        }
        
        .gameover-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .gameover-label {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .gameover-value {
            color: #fff;
            font-weight: 700;
        }
        
        .restart-btn {
            background: linear-gradient(90deg, #3b82f6, #6ee7b7);
            border: none;
            color: white;
            padding: 20px 50px;
            font-size: 22px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 700;
            transition: transform 0.3s;
        }
        
        .restart-btn:hover {
            transform: scale(1.05);
        }
        
        /* ÊâãÂã¢ÁãÄÊÖãÊåáÁ§∫ */
        .gesture-status {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 15px;
            padding: 15px 20px;
            font-size: 14px;
            color: #fff;
            z-index: 100;
        }
        
        .camera-feed {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 200px;
            height: 150px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.3);
            z-index: 100;
            display: none;
        }
        
        .camera-feed video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .warning {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 59, 48, 0.9);
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            max-width: 500px;
            z-index: 1000;
            display: none;
        }
        
        .warning h3 {
            margin-bottom: 15px;
            color: #fff;
        }
        
        .warning p {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 20px;
        }
        
        .warning button {
            background: #fff;
            color: #ff3b30;
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* ÊéßÂà∂Ë™™Êòé */
        .controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            border-radius: 15px;
            padding: 15px 20px;
            font-size: 14px;
            color: #fff;
            z-index: 100;
            text-align: center;
            display: none;
        }
        
        /* Áé©ÂÆ∂È£õËàπ */
        .player-ship {
            position: fixed;
            bottom: 100px;
            left: 50%;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #6ee7b7, #3b82f6);
            clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
            transform: translateX(-50%);
            z-index: 50;
            display: none;
            box-shadow: 0 0 20px rgba(110, 231, 183, 0.7);
        }
        
        /* Â≠êÂΩàÊïàÊûú */
        .bullet {
            position: absolute;
            width: 8px;
            height: 20px;
            background: linear-gradient(180deg, #6ee7b7, #3b82f6);
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(110, 231, 183, 0.8);
            display: none;
            z-index: 30;
        }
        
        /* Êïµ‰∫∫ */
        .enemy {
            position: absolute;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #ef4444, #f97316);
            border-radius: 10px;
            display: none;
            z-index: 20;
            transform: rotate(45deg);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.7);
        }
        
        .explosion {
            position: absolute;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, #fbbf24 0%, #ef4444 70%, transparent 100%);
            border-radius: 50%;
            display: none;
            z-index: 40;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <!-- ÈÅäÊà≤‰ªãÈù¢ -->
    <div class="game-ui">
        <div class="score-board">
            <div class="score-label">SCORE</div>
            <div class="score-value" id="score">00000000</div>
        </div>
        
        <div class="combo-board">
            <div class="combo-label">COMBO</div>
            <div class="combo-value" id="combo">0</div>
        </div>
        
        <div class="enemy-count">
            <div class="enemy-label">ENEMIES</div>
            <div class="enemy-value" id="enemyCount">0</div>
        </div>
        
        <div class="life-board">
            <div class="life-label">SHIELD</div>
            <div class="life-bar">
                <div class="life-fill" id="lifeFill"></div>
            </div>
            <div class="life-value" id="lifeValue">100%</div>
        </div>
        
        <div class="weapon-board" id="weaponBoard">
            <div class="weapon-label">WEAPON SYSTEM</div>
            <div class="weapon-desc" id="weaponDesc">Basic Laser Lv.1</div>
        </div>
    </div>
    
    <!-- Áé©ÂÆ∂È£õËàπ -->
    <div class="player-ship" id="playerShip"></div>
    
    <!-- ÈñãÂßãÁï´Èù¢ -->
    <div class="start-screen" id="startScreen">
        <h1 class="game-title">TWICE SPACE SHOOTER</h1>
        <div class="difficulty-select">
            <button class="difficulty-btn active" data-difficulty="easy">Á∞°ÂñÆ</button>
            <button class="difficulty-btn" data-difficulty="normal">ÊôÆÈÄö</button>
            <button class="difficulty-btn" data-difficulty="hard">Âõ∞Èõ£</button>
        </div>
        
        <button class="start-game-btn" id="startButton">ÈñãÂßãÈÅäÊà≤</button>
        
        <div class="gesture-status" style="position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: auto;">
            üéÆ ÊâãÂã¢ÊéßÂà∂: üëã ÁßªÂãïÈ£õËàπ | ‚úä ÁôºÂ∞Ñ | ü§è ÁâπÊÆäÊ≠¶Âô®
        </div>
    </div>
    
    <!-- ÂÄíÊï∏Ë®àÊôÇÁï´Èù¢ -->
    <div class="countdown-screen" id="countdownScreen">
        <div class="countdown-number" id="countdownNumber">3</div>
        <div class="countdown-text">MISSION START</div>
    </div>
    
    <!-- ÈÅäÊà≤ÁµêÊùüÁï´Èù¢ -->
    <div class="gameover-screen" id="gameoverScreen">
        <h2 class="gameover-title">MISSION COMPLETE</h2>
        <div class="gameover-stats">
            <div class="gameover-stat">
                <span class="gameover-label">ÊúÄÁµÇÂàÜÊï∏</span>
                <span class="gameover-value" id="finalScore">00000000</span>
            </div>
            <div class="gameover-stat">
                <span class="gameover-label">ÊìäÊØÄÊïµÊ©ü</span>
                <span class="gameover-value" id="finalEnemies">0</span>
            </div>
            <div class="gameover-stat">
                <span class="gameover-label">ÊúÄÂ§ßÈÄ£Êìä</span>
                <span class="gameover-value" id="finalCombo">0</span>
            </div>
            <div class="gameover-stat">
                <span class="gameover-label">Â≠òÊ¥ªÊôÇÈñì</span>
                <span class="gameover-value" id="finalTime">0s</span>
            </div>
        </div>
        <button class="restart-btn" id="restartButton">ÂÜçÁé©‰∏ÄÊ¨°</button>
    </div>
    
    <!-- ÊéßÂà∂Ë™™Êòé -->
    <div class="controls" id="controls">
        üëã ÂºµÈñãÊâãÊéåÁßªÂãïÈ£õËàπ | ‚úä Êè°Êã≥ÁôºÂ∞ÑÊøÄÂÖâ | ü§è ÊçèÂêà‰ΩøÁî®ÁâπÊÆäÊ≠¶Âô®
    </div>
    
    <!-- Èè°È†≠Áï´Èù¢ -->
    <div class="camera-feed" id="cameraFeed">
        <video id="input_video" autoplay muted></video>
    </div>
    
    <!-- Ê¨äÈôêË≠¶Âëä -->
    <div id="permissionWarning" class="warning">
        <h3>ÈúÄË¶ÅÊîùÂΩ±Ê©üÊ¨äÈôê</h3>
        <p>Ë´ãÂÖÅË®±ÊîùÂΩ±Ê©üÂ≠òÂèñ‰ª•‰ΩøÁî®ÊâãÂã¢ÊéßÂà∂ÂäüËÉΩ</p>
        <button onclick="location.reload()">ÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.min.js"></script>
    
    <script>
        // ==================== ÈÅäÊà≤‰∫íÂãïË¶èÂâáÈÖçÁΩÆ ====================
        const GAME_RULES = {
            // ‰∫ã‰ª∂ -> Ë°åÁÇ∫Êò†Â∞Ñ
            OPEN_BOTH: {
                action: 'rapidFire',
                strength: 1.0,
                description: 'ÈõôÊâãÂºµÈñãÔºöÂø´ÈÄüÂ∞ÑÊìäÊ®°Âºè'
            },
            CLOSE_BOTH: {
                action: 'shield',
                strength: 1.0,
                description: 'ÈõôÊâãÊè°Êã≥ÔºöÂïüÂãïË≠∑Áõæ'
            },
            PINCH_LEFT: {
                action: 'switchWeapon',
                direction: -1,
                description: 'Â∑¶ÊâãÊçèÂêàÔºöÂàáÊèõÊ≠¶Âô®'
            },
            PINCH_RIGHT: {
                action: 'switchWeapon',
                direction: 1,
                description: 'Âè≥ÊâãÊçèÂêàÔºöÂàáÊèõÊ≠¶Âô®'
            },
            MOVE_LEFT_HAND: {
                action: 'moveLeft',
                hand: 'left',
                strength: 0.8,
                description: 'Â∑¶ÊâãÁßªÂãïÔºöÊéßÂà∂È£õËàπ'
            },
            MOVE_RIGHT_HAND: {
                action: 'moveRight',
                hand: 'right',
                strength: 0.8,
                description: 'Âè≥ÊâãÁßªÂãïÔºöÊéßÂà∂È£õËàπ'
            },
            NO_HANDS: {
                action: 'idle',
                strength: 0.1,
                description: 'ÁÑ°ÊâãÂã¢ÔºöËá™ÂãïÈò≤Á¶¶'
            },
            PINCH_BOTH: {
                action: 'specialAttack',
                strength: 2.0,
                description: 'ÈõôÊâãÊçèÂêàÔºöÁâπÊÆäÊîªÊìä'
            },
            OPEN_LEFT: {
                action: 'moveLeft',
                hand: 'left',
                strength: 0.6,
                description: 'Â∑¶ÊâãÂºµÈñãÔºöÂêëÂ∑¶ÁßªÂãï'
            },
            OPEN_RIGHT: {
                action: 'moveRight',
                hand: 'right',
                strength: 0.6,
                description: 'Âè≥ÊâãÂºµÈñãÔºöÂêëÂè≥ÁßªÂãï'
            }
        };
        // ========================================================

        class SpaceShooterGame {
            constructor() {
                // ÈÅäÊà≤ÁãÄÊÖã
                this.gameState = {
                    score: 0,
                    combo: 0,
                    maxCombo: 0,
                    enemiesDestroyed: 0,
                    enemiesActive: 0,
                    enemiesTotal: 0,
                    life: 100,
                    shield: 0,
                    isPlaying: false,
                    isCountingDown: false,
                    gameTime: 0,
                    difficulty: 'normal',
                    weaponLevel: 1,
                    rapidFire: false,
                    specialAttackReady: true,
                    specialAttackCooldown: 0,
                    gameStarted: false,
                    cameraActive: false
                };
                
                // ÊâãÂã¢Êï∏Êìö
                this.handData = {
                    left: { landmarks: null, openness: 0, smoothedOpenness: 0, position: null },
                    right: { landmarks: null, openness: 0, smoothedOpenness: 0, position: null }
                };
                
                // ÈÅäÊà≤Â∞çË±°
                this.player = {
                    x: window.innerWidth / 2,
                    y: window.innerHeight - 150,
                    width: 60,
                    height: 60,
                    speed: 10,
                    shooting: false,
                    lastShot: 0
                };
                
                // Â≠êÂΩàÂíåÊïµ‰∫∫Êï∏ÁµÑ
                this.bullets = [];
                this.enemies = [];
                this.explosions = [];
                
                // Ê≠¶Âô®Á≥ªÁµ±
                this.weapons = [
                    { name: 'Basic Laser', level: 1, damage: 10, fireRate: 300, color: '#6ee7b7' },
                    { name: 'Plasma Cannon', level: 1, damage: 25, fireRate: 500, color: '#3b82f6' },
                    { name: 'Photon Blaster', level: 1, damage: 50, fireRate: 800, color: '#ef4444' }
                ];
                this.currentWeapon = 0;
                
                // Èõ£Â∫¶Ë®≠ÂÆö
                this.difficulties = {
                    easy: { enemySpeed: 2, enemySpawnRate: 1000, enemyHealth: 10 },
                    normal: { enemySpeed: 3, enemySpawnRate: 800, enemyHealth: 20 },
                    hard: { enemySpeed: 4, enemySpawnRate: 600, enemyHealth: 30 }
                };
                
                // ÊÄßËÉΩÁõ£Êéß
                this.lastEnemySpawn = 0;
                this.lastSpecialAttack = 0;
                
                // ÂàùÂßãÂåñ
                this.initThreeJS();
                this.initMediaPipe();
                this.initUI();
                this.initGameObjects();
                
                // È°ØÁ§∫ÈñãÂßãÁï´Èù¢
                this.showStartScreen();
            }
            
            initThreeJS() {
                // ÂâµÂª∫Â†¥ÊôØ
                this.scene = new THREE.Scene();
                
                // ÂâµÂª∫Áõ∏Ê©ü
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.camera.position.z = 15;
                
                // ÂâµÂª∫Ê∏≤ÊüìÂô®
                this.renderer = new THREE.WebGLRenderer({ 
                    canvas: document.getElementById('gameCanvas'),
                    antialias: true,
                    alpha: true,
                    powerPreference: "high-performance"
                });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                this.renderer.setClearColor(0x000000, 1);
                
                // ÂâµÂª∫ÊòüÁ©∫ËÉåÊôØ
                this.createStarfield();
                
                // ÂâµÂª∫ÊòüÈõ≤ÊïàÊûú
                this.createNebula();
                
                // Ê∑ªÂä†Áí∞Â¢ÉÂÖâ
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.3);
                this.scene.add(ambientLight);
                
                // Ê∑ªÂä†ÈªûÂÖâÊ∫ê
                const pointLight = new THREE.PointLight(0x6ee7b7, 1, 100);
                pointLight.position.set(10, 10, 10);
                this.scene.add(pointLight);
                
                // ÂâµÂª∫Áé©ÂÆ∂È£õËàπÊ®°Âûã
                this.createPlayerShip();
                
                // ÂâµÂª∫Êïµ‰∫∫Ê®°ÂûãÊ±†
                this.createEnemyPool();
                
                // ÂâµÂª∫Â≠êÂΩàÊ®°ÂûãÊ±†
                this.createBulletPool();
                
                // Ë¶ñÁ™óÂ§ßÂ∞èË™øÊï¥ËôïÁêÜ
                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });
            }
            
            createStarfield() {
                // ÂâµÂª∫ÊòüÁ©∫
                const starGeometry = new THREE.BufferGeometry();
                const starCount = 1000;
                const positions = new Float32Array(starCount * 3);
                
                for (let i = 0; i < starCount * 3; i += 3) {
                    positions[i] = (Math.random() - 0.5) * 2000;
                    positions[i + 1] = (Math.random() - 0.5) * 2000;
                    positions[i + 2] = (Math.random() - 0.5) * 2000;
                }
                
                starGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                
                const starMaterial = new THREE.PointsMaterial({
                    color: 0xffffff,
                    size: 0.7,
                    transparent: true,
                    opacity: 0.8,
                    blending: THREE.AdditiveBlending
                });
                
                this.stars = new THREE.Points(starGeometry, starMaterial);
                this.scene.add(this.stars);
            }
            
            createNebula() {
                // ÂâµÂª∫ÊòüÈõ≤ÊïàÊûú
                const nebulaGeometry = new THREE.SphereGeometry(100, 32, 32);
                const nebulaMaterial = new THREE.MeshBasicMaterial({
                    color: 0x3b82f6,
                    transparent: true,
                    opacity: 0.1,
                    side: THREE.BackSide
                });
                
                this.nebula = new THREE.Mesh(nebulaGeometry, nebulaMaterial);
                this.scene.add(this.nebula);
            }
            
            createPlayerShip() {
                // ÂâµÂª∫Áé©ÂÆ∂È£õËàπÊ®°Âûã
                const shipGeometry = new THREE.ConeGeometry(0.5, 1.5, 8);
                const shipMaterial = new THREE.MeshPhongMaterial({
                    color: 0x6ee7b7,
                    shininess: 100,
                    emissive: 0x006600,
                    emissiveIntensity: 0.5
                });
                
                this.playerShip = new THREE.Mesh(shipGeometry, shipMaterial);
                this.playerShip.position.z = 5;
                this.scene.add(this.playerShip);
                
                // ÂâµÂª∫È£õËàπÂºïÊìéÁ≤íÂ≠ê
                this.createEngineParticles();
            }
            
            createEngineParticles() {
                // È£õËàπÂºïÊìéÁ≤íÂ≠ê
                const particleCount = 100;
                const particles = new THREE.BufferGeometry();
                const positions = new Float32Array(particleCount * 3);
                const colors = new Float32Array(particleCount * 3);
                
                for (let i = 0; i < particleCount; i++) {
                    const i3 = i * 3;
                    positions[i3] = (Math.random() - 0.5) * 0.3;
                    positions[i3 + 1] = -1.5;
                    positions[i3 + 2] = (Math.random() - 0.5) * 0.3;
                    
                    colors[i3] = 1.0; // R
                    colors[i3 + 1] = 0.9; // G
                    colors[i3 + 2] = 0.1; // B
                }
                
                particles.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                particles.setAttribute('color', new THREE.BufferAttribute(colors, 3));
                
                const particleMaterial = new THREE.PointsMaterial({
                    size: 0.1,
                    vertexColors: true,
                    transparent: true,
                    opacity: 0.8,
                    blending: THREE.AdditiveBlending
                });
                
                this.engineParticles = new THREE.Points(particles, particleMaterial);
                this.playerShip.add(this.engineParticles);
            }
            
            createEnemyPool() {
                // ÂâµÂª∫Êïµ‰∫∫Ê®°ÂûãÊ±†
                this.enemyPool = [];
                const enemyGeometry = new THREE.OctahedronGeometry(0.8);
                const enemyMaterial = new THREE.MeshPhongMaterial({
                    color: 0xef4444,
                    shininess: 50,
                    emissive: 0x440000,
                    emissiveIntensity: 0.3
                });
                
                for (let i = 0; i < 20; i++) {
                    const enemy = new THREE.Mesh(enemyGeometry, enemyMaterial);
                    enemy.visible = false;
                    this.scene.add(enemy);
                    this.enemyPool.push({
                        mesh: enemy,
                        active: false,
                        x: 0,
                        y: 0,
                        health: 0,
                        speed: 0
                    });
                }
            }
            
            createBulletPool() {
                // ÂâµÂª∫Â≠êÂΩàÊ®°ÂûãÊ±†
                this.bulletPool = [];
                const bulletGeometry = new THREE.CylinderGeometry(0.05, 0.05, 0.5, 8);
                
                for (let i = 0; i < 50; i++) {
                    const bulletMaterial = new THREE.MeshPhongMaterial({
                        color: 0x6ee7b7,
                        emissive: 0x006600,
                        emissiveIntensity: 0.8,
                        transparent: true,
                        opacity: 0.9
                    });
                    
                    const bullet = new THREE.Mesh(bulletGeometry, bulletMaterial);
                    bullet.visible = false;
                    this.scene.add(bullet);
                    this.bulletPool.push({
                        mesh: bullet,
                        active: false,
                        x: 0,
                        y: 0,
                        speed: 0
                    });
                }
            }
            
            initMediaPipe() {
                // ÂâµÂª∫Ë¶ñÈ†ªÂÖÉÁ¥†
                this.videoElement = document.getElementById('input_video');
                
                // ÂàùÂßãÂåñ MediaPipe Hands
                this.hands = new Hands({
                    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/${file}`
                });
                
                // Ë®≠ÁΩÆÈÅ∏È†Ö
                this.hands.setOptions({
                    maxNumHands: 2,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
                
                // Ë®≠ÁΩÆÁµêÊûúÂõûË™ø
                this.hands.onResults((results) => {
                    this.onHandResults(results);
                });
                
                // ÂàùÂßãÂåñÁõ∏Ê©ü
                const camera = new Camera(this.videoElement, {
                    onFrame: async () => {
                        if (this.gameState.isPlaying || this.gameState.isCountingDown) {
                            await this.hands.send({image: this.videoElement});
                        }
                    },
                    width: 640,
                    height: 480
                });
                
                // ÂïüÂãïÁõ∏Ê©ü
                camera.start().then(() => {
                    this.gameState.cameraActive = true;
                    this.showCameraFeed();
                }).catch((error) => {
                    console.error('Camera error:', error);
                    document.getElementById('permissionWarning').style.display = 'block';
                });
                
                // Ë®≠ÁΩÆÂπ≥Êªë‰øÇÊï∏
                this.smoothingFactor = 0.2;
            }
            
            showCameraFeed() {
                const cameraFeed = document.getElementById('cameraFeed');
                cameraFeed.style.display = 'block';
            }
            
            initUI() {
                // ÈñãÂßãÊåâÈàï
                document.getElementById('startButton').addEventListener('click', () => {
                    this.startGame();
                });
                
                // Èõ£Â∫¶ÈÅ∏Êìá
                document.querySelectorAll('.difficulty-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.gameState.difficulty = e.target.dataset.difficulty;
                    });
                });
                
                // ÈáçÊñ∞ÈñãÂßãÊåâÈàï
                document.getElementById('restartButton').addEventListener('click', () => {
                    this.restartGame();
                });
                
                // È°ØÁ§∫ÊéßÂà∂Ë™™Êòé
                document.getElementById('controls').style.display = 'block';
            }
            
            initGameObjects() {
                // È°ØÁ§∫Áé©ÂÆ∂È£õËàπ
                document.getElementById('playerShip').style.display = 'block';
            }
            
            onHandResults(results) {
                // ÈáçÁΩÆÊâãÈÉ®Êï∏Êìö
                this.handData.left.landmarks = null;
                this.handData.right.landmarks = null;
                
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    results.multiHandLandmarks.forEach((landmarks, index) => {
                        const handedness = results.multiHandedness[index].label;
                        const hand = handedness === 'Left' ? 'right' : 'left'; // MediaPipe Â∫ßÊ®ôËΩâÊèõ
                        
                        this.handData[hand].landmarks = landmarks;
                        this.handData[hand].openness = this.calculateHandOpenness(landmarks);
                        
                        // Âπ≥ÊªëËôïÁêÜ
                        this.handData[hand].smoothedOpenness += 
                            (this.handData[hand].openness - this.handData[hand].smoothedOpenness) * this.smoothingFactor;
                        
                        // Ë®àÁÆóÊâãÈÉ®‰ΩçÁΩÆÔºàËΩâÊèõÁÇ∫Â±èÂπïÁ©∫ÈñìÔºâ
                        const wrist = landmarks[0];
                        const screenX = wrist.x * window.innerWidth;
                        const screenY = (1 - wrist.y) * window.innerHeight;
                        
                        this.handData[hand].position = {
                            x: screenX,
                            y: screenY
                        };
                    });
                    
                    // ÊáâÁî®ÈÅäÊà≤Ë¶èÂâá
                    this.applyGameRules();
                } else {
                    // Ê≤íÊúâÊ™¢Ê∏¨Âà∞ÊâãÈÉ®
                    this.handData.left.landmarks = null;
                    this.handData.right.landmarks = null;
                    
                    // Âü∑Ë°åÁÑ°ÊâãÂã¢Ë¶èÂâá
                    this.executeAction(GAME_RULES.NO_HANDS);
                }
            }
            
            calculateHandOpenness(landmarks) {
                if (!landmarks) return 0;
                
                // Ë®àÁÆóÊéåÂøÉ‰ΩçÁΩÆ
                const wrist = landmarks[0];
                const palmX = (landmarks[0].x + landmarks[5].x + landmarks[17].x) / 3;
                const palmY = (landmarks[0].y + landmarks[5].y + landmarks[17].y) / 3;
                const palmZ = (landmarks[0].z + landmarks[5].z + landmarks[17].z) / 3;
                
                // Ë®àÁÆóÊåáÂ∞ñÂà∞ÊéåÂøÉÁöÑË∑ùÈõ¢
                const fingerIndices = [4, 8, 12, 16, 20];
                let totalDistance = 0;
                
                fingerIndices.forEach(idx => {
                    const dx = landmarks[idx].x - palmX;
                    const dy = landmarks[idx].y - palmY;
                    const dz = landmarks[idx].z - palmZ;
                    totalDistance += Math.sqrt(dx * dx + dy * dy + dz * dz);
                });
                
                // Ê≠£Ë¶èÂåñÂà∞ [0, 1]
                const normalized = Math.min(totalDistance / 0.5, 1);
                return normalized;
            }
            
            calculatePinch(landmarks) {
                if (!landmarks) return 1;
                const thumb = landmarks[4];
                const index = landmarks[8];
                const dx = thumb.x - index.x;
                const dy = thumb.y - index.y;
                const dz = thumb.z - index.z;
                return Math.sqrt(dx * dx + dy * dy + dz * dz);
            }
            
            applyGameRules() {
                const left = this.handData.left;
                const right = this.handData.right;
                
                // Ê™¢Êü•ÊçèÂêàÊâãÂã¢
                const pinchThreshold = 0.05;
                let leftPinch = false;
                let rightPinch = false;
                
                if (left.landmarks && this.calculatePinch(left.landmarks) < pinchThreshold) {
                    leftPinch = true;
                    if (Date.now() - this.lastSpecialAttack > 500) {
                        this.executeAction(GAME_RULES.PINCH_LEFT);
                        this.lastSpecialAttack = Date.now();
                    }
                }
                
                if (right.landmarks && this.calculatePinch(right.landmarks) < pinchThreshold) {
                    rightPinch = true;
                    if (Date.now() - this.lastSpecialAttack > 500) {
                        this.executeAction(GAME_RULES.PINCH_RIGHT);
                        this.lastSpecialAttack = Date.now();
                    }
                }
                
                // ÈõôÊâãÂêåÊôÇÊçèÂêà
                if (leftPinch && rightPinch) {
                    if (Date.now() - this.lastSpecialAttack > 1000) {
                        this.executeAction(GAME_RULES.PINCH_BOTH);
                        this.lastSpecialAttack = Date.now();
                    }
                }
                
                // ÈõôÊâãÂºµÈñã/ÈñâÂêà
                if (left.landmarks && right.landmarks) {
                    const avgOpenness = (left.smoothedOpenness + right.smoothedOpenness) / 2;
                    
                    if (avgOpenness > 0.7) {
                        this.executeAction(GAME_RULES.OPEN_BOTH);
                    } else if (avgOpenness < 0.3) {
                        this.executeAction(GAME_RULES.CLOSE_BOTH);
                    }
                }
                
                // ÂñÆÊâãÂºµÈñã
                if (left.landmarks && left.smoothedOpenness > 0.7) {
                    this.executeAction(GAME_RULES.OPEN_LEFT);
                }
                
                if (right.landmarks && right.smoothedOpenness > 0.7) {
                    this.executeAction(GAME_RULES.OPEN_RIGHT);
                }
                
                // ÂñÆÊâãÁßªÂãï
                if (left.landmarks && left.position) {
                    this.executeAction(GAME_RULES.MOVE_LEFT_HAND);
                }
                if (right.landmarks && right.position) {
                    this.executeAction(GAME_RULES.MOVE_RIGHT_HAND);
                }
                
                // Ëá™ÂãïÂ∞ÑÊìäÔºàÁï∂ÊâãÂºµÈñãÊôÇÔºâ
                if (left.landmarks && left.smoothedOpenness > 0.6) {
                    this.player.shooting = true;
                }
                
                if (right.landmarks && right.smoothedOpenness > 0.6) {
                    this.player.shooting = true;
                }
            }
            
            executeAction(rule) {
                // Êõ¥Êñ∞ÊâãÂã¢ÁãÄÊÖãÈ°ØÁ§∫
                if (rule.description) {
                    document.getElementById('gestureStatus').textContent = rule.description;
                }
                
                // Âü∑Ë°åÂ∞çÊáâË°åÁÇ∫
                switch (rule.action) {
                    case 'rapidFire':
                        this.activateRapidFire(rule.strength);
                        break;
                    case 'shield':
                        this.activateShield(rule.strength);
                        break;
                    case 'switchWeapon':
                        this.switchWeapon(rule.direction);
                        break;
                    case 'moveLeft':
                        this.movePlayer('left', rule.strength);
                        break;
                    case 'moveRight':
                        this.movePlayer('right', rule.strength);
                        break;
                    case 'specialAttack':
                        this.specialAttack(rule.strength);
                        break;
                    case 'idle':
                        this.idleMode(rule.strength);
                        break;
                }
            }
            
            // ============ Ë°åÁÇ∫ÂØ¶‰Ωú ============
            activateRapidFire(strength) {
                this.gameState.rapidFire = true;
                setTimeout(() => {
                    this.gameState.rapidFire = false;
                }, 2000 * strength);
            }
            
            activateShield(strength) {
                this.gameState.shield = 50 * strength;
                this.playerShip.material.emissive.setHex(0x0066ff);
                this.playerShip.material.emissiveIntensity = 0.8;
                
                setTimeout(() => {
                    this.gameState.shield = 0;
                    this.playerShip.material.emissive.setHex(0x006600);
                    this.playerShip.material.emissiveIntensity = 0.5;
                }, 3000 * strength);
            }
            
            switchWeapon(direction) {
                this.currentWeapon = (this.currentWeapon + direction + this.weapons.length) % this.weapons.length;
                const weapon = this.weapons[this.currentWeapon];
                document.getElementById('weaponDesc').textContent = `${weapon.name} Lv.${weapon.level}`;
                
                // Êõ¥Êñ∞Ê≠¶Âô®È°ØÁ§∫È°èËâ≤
                document.getElementById('weaponBoard').style.borderColor = weapon.color;
            }
            
            movePlayer(direction, strength) {
                const hand = direction === 'left' ? this.handData.left : this.handData.right;
                if (!hand.position) return;
                
                // Ë®àÁÆóÁßªÂãïÁõÆÊ®ô
                const targetX = hand.position.x;
                const currentX = this.playerShip.position.x;
                
                // Âπ≥ÊªëÁßªÂãï
                const moveSpeed = 0.1 * strength;
                const newX = currentX + (targetX - currentX) * moveSpeed;
                
                // ÈôêÂà∂ÁßªÂãïÁØÑÂúç
                const screenWidth = window.innerWidth;
                const minX = -screenWidth / 100 + 2;
                const maxX = screenWidth / 100 - 2;
                
                this.playerShip.position.x = Math.max(minX, Math.min(maxX, newX));
                
                // Êõ¥Êñ∞2DÈ°ØÁ§∫
                const playerShip2D = document.getElementById('playerShip');
                const screenX = ((this.playerShip.position.x + 10) / 20) * window.innerWidth;
                playerShip2D.style.left = `${screenX}px`;
            }
            
            specialAttack(strength) {
                if (!this.gameState.specialAttackReady) return;
                
                // ÁôºÂ∞ÑÁâπÊÆäÊîªÊìä
                const weapon = this.weapons[this.currentWeapon];
                
                // ÂâµÂª∫Â§ßÂûãËÉΩÈáèÂΩà
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        this.createSpecialBullet(i * 0.2);
                    }, i * 100);
                }
                
                this.gameState.specialAttackReady = false;
                this.gameState.specialAttackCooldown = 5000;
                
                setTimeout(() => {
                    this.gameState.specialAttackReady = true;
                }, 5000);
            }
            
            createSpecialBullet(delay) {
                const bullet = this.getBulletFromPool();
                if (!bullet) return;
                
                bullet.active = true;
                bullet.x = this.playerShip.position.x * 10;
                bullet.y = this.playerShip.position.y + 10;
                bullet.speed = 25;
                bullet.damage = 100;
                bullet.special = true;
                
                bullet.mesh.position.set(this.playerShip.position.x, this.playerShip.position.y, 5);
                bullet.mesh.scale.set(3, 3, 3);
                bullet.mesh.material.color.setHex(0xff0000);
                bullet.mesh.visible = true;
                
                // Ê∑ªÂä†Á≤íÂ≠êÊïàÊûú
                this.createBulletTrail(bullet);
            }
            
            idleMode(strength) {
                // Ëá™ÂãïÈò≤Á¶¶Ê®°Âºè
                this.player.shooting = false;
                
                // Á∑©ÊÖ¢ÊÅ¢Âæ©Ë≠∑Áõæ
                if (this.gameState.life < 100) {
                    this.gameState.life += 0.1 * strength;
                    this.updateLifeDisplay();
                }
            }
            
            spawnEnemy() {
                const difficulty = this.difficulties[this.gameState.difficulty];
                const now = Date.now();
                
                if (now - this.lastEnemySpawn > difficulty.enemySpawnRate) {
                    this.lastEnemySpawn = now;
                    
                    // Áç≤ÂèñÂèØÁî®ÁöÑÊïµ‰∫∫
                    const enemy = this.getEnemyFromPool();
                    if (!enemy) return;
                    
                    // Ë®≠ÁΩÆÊïµ‰∫∫Â±¨ÊÄß
                    enemy.active = true;
                    enemy.x = Math.random() * (window.innerWidth - 100) + 50;
                    enemy.y = -50;
                    enemy.health = difficulty.enemyHealth;
                    enemy.speed = difficulty.enemySpeed * (0.8 + Math.random() * 0.4);
                    
                    // Ë®≠ÁΩÆ3D‰ΩçÁΩÆ
                    enemy.mesh.position.x = (enemy.x / window.innerWidth - 0.5) * 20;
                    enemy.mesh.position.y = 10;
                    enemy.mesh.position.z = 5;
                    enemy.mesh.visible = true;
                    
                    // Èö®Ê©üÊóãËΩâ
                    enemy.mesh.rotation.x = Math.random() * Math.PI * 2;
                    enemy.mesh.rotation.y = Math.random() * Math.PI * 2;
                    
                    this.gameState.enemiesActive++;
                    this.gameState.enemiesTotal++;
                    this.updateEnemyCount();
                }
            }
            
            getEnemyFromPool() {
                return this.enemyPool.find(enemy => !enemy.active);
            }
            
            getBulletFromPool() {
                return this.bulletPool.find(bullet => !bullet.active);
            }
            
            shoot() {
                if (!this.player.shooting) return;
                
                const now = Date.now();
                const weapon = this.weapons[this.currentWeapon];
                const fireRate = this.gameState.rapidFire ? weapon.fireRate / 2 : weapon.fireRate;
                
                if (now - this.player.lastShot > fireRate) {
                    this.player.lastShot = now;
                    
                    // ÂâµÂª∫Â≠êÂΩà
                    const bullet = this.getBulletFromPool();
                    if (!bullet) return;
                    
                    bullet.active = true;
                    bullet.x = this.playerShip.position.x * 10;
                    bullet.y = this.playerShip.position.y + 10;
                    bullet.speed = 15;
                    bullet.damage = weapon.damage;
                    
                    bullet.mesh.position.set(this.playerShip.position.x, this.playerShip.position.y, 5);
                    bullet.mesh.scale.set(1, 1, 1);
                    bullet.mesh.material.color.setHex(parseInt(weapon.color.replace('#', ''), 16));
                    bullet.mesh.visible = true;
                }
            }
            
            createBulletTrail(bullet) {
                // ÂâµÂª∫Â≠êÂΩàÂ∞æË∑°
                const trailGeometry = new THREE.BufferGeometry();
                const positions = new Float32Array(10 * 3);
                
                for (let i = 0; i < 10; i++) {
                    const i3 = i * 3;
                    positions[i3] = bullet.mesh.position.x;
                    positions[i3 + 1] = bullet.mesh.position.y - i * 0.1;
                    positions[i3 + 2] = bullet.mesh.position.z;
                }
                
                trailGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                
                const trailMaterial = new THREE.LineBasicMaterial({
                    color: parseInt(this.weapons[this.currentWeapon].color.replace('#', ''), 16),
                    transparent: true,
                    opacity: 0.5,
                    linewidth: 2
                });
                
                const trail = new THREE.Line(trailGeometry, trailMaterial);
                this.scene.add(trail);
                
                // Á®çÂæåÁßªÈô§Â∞æË∑°
                setTimeout(() => {
                    this.scene.remove(trail);
                }, 100);
            }
            
            updateBullets() {
                this.bulletPool.forEach(bullet => {
                    if (!bullet.active) return;
                    
                    // ÁßªÂãïÂ≠êÂΩà
                    bullet.y += bullet.speed;
                    bullet.mesh.position.y += bullet.speed / 10;
                    
                    // Ê™¢Êü•ÊòØÂê¶Ë∂ÖÂá∫Â±èÂπï
                    if (bullet.y > window.innerHeight + 100) {
                        bullet.active = false;
                        bullet.mesh.visible = false;
                        return;
                    }
                    
                    // Ê™¢Êü•Á¢∞Êíû
                    this.checkBulletCollision(bullet);
                });
            }
            
            checkBulletCollision(bullet) {
                this.enemyPool.forEach(enemy => {
                    if (!enemy.active) return;
                    
                    // Á∞°ÂñÆÁ¢∞ÊíûÊ™¢Ê∏¨
                    const dx = bullet.x - enemy.x;
                    const dy = bullet.y - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 40) {
                        // ÂëΩ‰∏≠Êïµ‰∫∫
                        enemy.health -= bullet.damage;
                        
                        if (enemy.health <= 0) {
                            // Êïµ‰∫∫Ë¢´ÊëßÊØÄ
                            this.destroyEnemy(enemy);
                            this.gameState.score += 100 * this.gameState.combo;
                            this.gameState.enemiesDestroyed++;
                            this.gameState.combo++;
                            this.gameState.maxCombo = Math.max(this.gameState.maxCombo, this.gameState.combo);
                            
                            // ÂâµÂª∫ÁàÜÁÇ∏ÊïàÊûú
                            this.createExplosion(enemy.x, enemy.y);
                        }
                        
                        // ÁßªÈô§Â≠êÂΩà
                        bullet.active = false;
                        bullet.mesh.visible = false;
                    }
                });
            }
            
            destroyEnemy(enemy) {
                enemy.active = false;
                enemy.mesh.visible = false;
                this.gameState.enemiesActive--;
                this.updateEnemyCount();
            }
            
            createExplosion(x, y) {
                // ÂâµÂª∫ÁàÜÁÇ∏ÊïàÊûú
                const explosionGeometry = new THREE.SphereGeometry(1, 16, 16);
                const explosionMaterial = new THREE.MeshBasicMaterial({
                    color: 0xff9900,
                    transparent: true,
                    opacity: 0.8
                });
                
                const explosion = new THREE.Mesh(explosionGeometry, explosionMaterial);
                explosion.position.set(
                    (x / window.innerWidth - 0.5) * 20,
                    10,
                    5
                );
                this.scene.add(explosion);
                
                // ÁàÜÁÇ∏ÂãïÁï´
                let scale = 1;
                const animateExplosion = () => {
                    scale += 0.2;
                    explosion.scale.set(scale, scale, scale);
                    explosion.material.opacity -= 0.05;
                    
                    if (explosion.material.opacity > 0) {
                        requestAnimationFrame(animateExplosion);
                    } else {
                        this.scene.remove(explosion);
                    }
                };
                
                animateExplosion();
            }
            
            updateEnemies() {
                this.enemyPool.forEach(enemy => {
                    if (!enemy.active) return;
                    
                    // ÁßªÂãïÊïµ‰∫∫
                    enemy.y += enemy.speed;
                    enemy.mesh.position.y -= enemy.speed / 50;
                    
                    // Ê™¢Êü•ÊòØÂê¶Âà∞ÈÅîÂ∫ïÈÉ®
                    if (enemy.y > window.innerHeight + 100) {
                        enemy.active = false;
                        enemy.mesh.visible = false;
                        this.gameState.enemiesActive--;
                        this.updateEnemyCount();
                        
                        // Êâ£Ê∏õÁîüÂëΩÂÄº
                        this.gameState.life -= 10;
                        this.gameState.combo = 0;
                        this.updateLifeDisplay();
                        
                        if (this.gameState.life <= 0) {
                            this.gameOver();
                        }
                    }
                    
                    // ÊóãËΩâÊïµ‰∫∫
                    enemy.mesh.rotation.x += 0.02;
                    enemy.mesh.rotation.y += 0.03;
                });
            }
            
            updateLifeDisplay() {
                document.getElementById('lifeFill').style.width = `${this.gameState.life}%`;
                document.getElementById('lifeValue').textContent = `${Math.floor(this.gameState.life)}%`;
                
                // Ê†πÊìöÁîüÂëΩÂÄºÊîπËÆäÈ°èËâ≤
                if (this.gameState.life > 70) {
                    document.getElementById('lifeFill').style.background = 'linear-gradient(90deg, #6ee7b7, #3b82f6)';
                } else if (this.gameState.life > 30) {
                    document.getElementById('lifeFill').style.background = 'linear-gradient(90deg, #fbbf24, #f97316)';
                } else {
                    document.getElementById('lifeFill').style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
                }
            }
            
            updateEnemyCount() {
                document.getElementById('enemyCount').textContent = this.gameState.enemiesDestroyed;
            }
            
            updateUI() {
                // Êõ¥Êñ∞ÂàÜÊï∏
                document.getElementById('score').textContent = Math.floor(this.gameState.score).toString().padStart(8, '0');
                document.getElementById('combo').textContent = this.gameState.combo;
                
                // Êõ¥Êñ∞ÁâπÊÆäÊîªÊìäÂÜ∑Âçª
                if (!this.gameState.specialAttackReady) {
                    this.gameState.specialAttackCooldown -= 16;
                    if (this.gameState.specialAttackCooldown <= 0) {
                        this.gameState.specialAttackReady = true;
                    }
                }
            }
            
            startCountdown() {
                this.gameState.isCountingDown = true;
                const countdownScreen = document.getElementById('countdownScreen');
                const countdownNumber = document.getElementById('countdownNumber');
                
                countdownScreen.style.display = 'flex';
                this.countdownTime = 3;
                countdownNumber.textContent = this.countdownTime;
                
                this.countdownInterval = setInterval(() => {
                    this.countdownTime--;
                    countdownNumber.textContent = this.countdownTime;
                    
                    if (this.countdownTime <= 0) {
                        clearInterval(this.countdownInterval);
                        countdownScreen.style.display = 'none';
                        this.startGamePlay();
                    }
                }, 1000);
            }
            
            startGamePlay() {
                this.gameState.isCountingDown = false;
                this.gameState.isPlaying = true;
                this.gameState.gameStarted = true;
                
                // ÈñãÂßãÈÅäÊà≤ÂãïÁï´Âæ™Áí∞
                this.animate();
            }
            
            startGame() {
                // ÈáçÁΩÆÈÅäÊà≤ÁãÄÊÖã
                this.resetGameState();
                
                // Èö±ËóèÈñãÂßãÁï´Èù¢
                document.getElementById('startScreen').style.display = 'none';
                
                // ÈñãÂßã3ÁßíÂÄíÊï∏Ë®àÊôÇ
                this.startCountdown();
            }
            
            restartGame() {
                // ÂÆåÂÖ®ÈáçÁΩÆÈÅäÊà≤
                this.resetGame();
                
                // ÈáçÊñ∞ÈñãÂßãÈÅäÊà≤
                this.startGame();
            }
            
            resetGame() {
                // ÂÅúÊ≠¢ÈÅäÊà≤
                this.gameState.isPlaying = false;
                this.gameState.gameStarted = false;
                
                // Ê∏ÖÈô§ÊâÄÊúâÊïµ‰∫∫
                this.enemyPool.forEach(enemy => {
                    enemy.active = false;
                    enemy.mesh.visible = false;
                });
                
                // Ê∏ÖÈô§ÊâÄÊúâÂ≠êÂΩà
                this.bulletPool.forEach(bullet => {
                    bullet.active = false;
                    bullet.mesh.visible = false;
                });
                
                // ÂÅúÊ≠¢ÂãïÁï´Âæ™Áí∞
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
                
                // ÂÅúÊ≠¢ÂÄíÊï∏Ë®àÊôÇ
                if (this.countdownInterval) {
                    clearInterval(this.countdownInterval);
                }
                
                // Èö±ËóèÈÅäÊà≤ÁµêÊùüÁï´Èù¢
                document.getElementById('gameoverScreen').style.display = 'none';
                
                // È°ØÁ§∫ÈñãÂßãÁï´Èù¢
                document.getElementById('startScreen').style.display = 'flex';
            }
            
            resetGameState() {
                this.gameState = {
                    score: 0,
                    combo: 0,
                    maxCombo: 0,
                    enemiesDestroyed: 0,
                    enemiesActive: 0,
                    enemiesTotal: 0,
                    life: 100,
                    shield: 0,
                    isPlaying: false,
                    isCountingDown: false,
                    gameTime: 0,
                    difficulty: this.gameState.difficulty,
                    weaponLevel: 1,
                    rapidFire: false,
                    specialAttackReady: true,
                    specialAttackCooldown: 0,
                    gameStarted: false,
                    cameraActive: this.gameState.cameraActive
                };
                
                // ÈáçÁΩÆÁé©ÂÆ∂‰ΩçÁΩÆ
                this.playerShip.position.set(0, -5, 5);
                
                // ÈáçÁΩÆÊ≠¶Âô®
                this.currentWeapon = 0;
                document.getElementById('weaponDesc').textContent = 'Basic Laser Lv.1';
                document.getElementById('weaponBoard').style.borderColor = '#6ee7b7';
                
                // Êõ¥Êñ∞UI
                this.updateUI();
                this.updateLifeDisplay();
                this.updateEnemyCount();
            }
            
            gameOver() {
                // ÂÅúÊ≠¢ÈÅäÊà≤
                this.gameState.isPlaying = false;
                this.gameState.gameStarted = false;
                
                // ÂÅúÊ≠¢ÂãïÁï´Âæ™Áí∞
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
                
                // Êõ¥Êñ∞ÈÅäÊà≤ÁµêÊùüÁï´Èù¢Êï∏Êìö
                document.getElementById('finalScore').textContent = Math.floor(this.gameState.score).toString().padStart(8, '0');
                document.getElementById('finalEnemies').textContent = this.gameState.enemiesDestroyed;
                document.getElementById('finalCombo').textContent = this.gameState.maxCombo;
                document.getElementById('finalTime').textContent = `${Math.floor(this.gameState.gameTime / 1000)}s`;
                
                // È°ØÁ§∫ÈÅäÊà≤ÁµêÊùüÁï´Èù¢
                document.getElementById('gameoverScreen').style.display = 'flex';
            }
            
            showStartScreen() {
                document.getElementById('startScreen').style.display = 'flex';
                document.getElementById('gameoverScreen').style.display = 'none';
                document.getElementById('countdownScreen').style.display = 'none';
            }
            
            animate() {
                if (!this.gameState.isPlaying) return;
                
                this.animationId = requestAnimationFrame(() => this.animate());
                
                // Êõ¥Êñ∞ÈÅäÊà≤ÊôÇÈñì
                this.gameState.gameTime += 16;
                
                // ÁîüÊàêÊïµ‰∫∫
                this.spawnEnemy();
                
                // ÁôºÂ∞ÑÂ≠êÂΩà
                this.shoot();
                
                // Êõ¥Êñ∞ÈÅäÊà≤Â∞çË±°
                this.updateBullets();
                this.updateEnemies();
                
                // ÊóãËΩâÊòüÁ©∫ËÉåÊôØ
                if (this.stars) {
                    this.stars.rotation.y += 0.0005;
                }
                
                // ÊóãËΩâÊòüÈõ≤
                if (this.nebula) {
                    this.nebula.rotation.x += 0.0002;
                    this.nebula.rotation.y += 0.0003;
                }
                
                // ÊóãËΩâÈ£õËàπÂºïÊìéÁ≤íÂ≠ê
                if (this.engineParticles) {
                    this.engineParticles.rotation.y += 0.1;
                }
                
                // Êõ¥Êñ∞UI
                this.updateUI();
                
                // Ê∏≤ÊüìÂ†¥ÊôØ
                this.renderer.render(this.scene, this.camera);
            }
        }
        
        // ÂàùÂßãÂåñÈÅäÊà≤
        window.addEventListener('load', () => {
            window.game = new SpaceShooterGame();
        });
    </script>
</body>
</html>