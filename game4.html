<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>2048 Pro - Glass Edition</title>
<style>
:root{
  --glass-bg: rgba(255,255,255,0.15);
  --glass-border: rgba(255,255,255,0.3);
  --text:#ffffff;
}
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto}
body{
  margin:0;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(135deg,#667eea,#764ba2);
}
.wrap{
  width:100%;
  max-width:600px;
  padding:20px;
}
.panel{
  backdrop-filter: blur(18px);
  background: var(--glass-bg);
  border:1px solid var(--glass-border);
  border-radius:20px;
  padding:20px;
  color:var(--text);
  box-shadow:0 10px 40px rgba(0,0,0,0.2);
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:15px;
}
h1{margin:0;font-size:26px}
.controls{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
button,select,input{
  background:rgba(255,255,255,0.2);
  border:1px solid rgba(255,255,255,0.4);
  color:white;
  padding:6px 10px;
  border-radius:10px;
  cursor:pointer;
}
button:hover{background:rgba(255,255,255,0.3)}
.board{
  position:relative;
  margin-top:15px;
  border-radius:15px;
  padding:10px;
  backdrop-filter: blur(25px);
  background:rgba(255,255,255,0.1);
}
.grid{
  display:grid;
  gap:10px;
}
.cell{
  background:rgba(255,255,255,0.1);
  border-radius:12px;
  padding-bottom:100%;
  position:relative;
}
.tile{
  position:absolute;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  font-size:22px;
  color:#333;
  background:rgba(255,255,255,0.9);
  transition:all .15s ease;
}
.overlay{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.4);
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:15px;
  flex-direction:column;
  font-size:22px;
}
</style>
</head>
<body>
<div class="wrap">
<div class="panel">
<header>
  <h1>2048 Pro</h1>
  <div>Score: <span id="score">0</span></div>
</header>

<div class="controls">
  <button id="restart">重新開始</button>
  <button id="undo">撤銷</button>
  <label>盤面
    <select id="sizeSelect">
      <option value="3">3x3</option>
      <option value="4" selected>4x4</option>
      <option value="5">5x5</option>
      <option value="6">6x6</option>
    </select>
  </label>
  <label>目標
    <input id="targetInput" type="number" value="2048" min="128" step="128" style="width:80px"/>
  </label>
</div>

<div class="board" id="board">
  <div id="grid" class="grid"></div>
</div>
</div>
</div>

<script>
let SIZE=4;
let TARGET=2048;
let board=[];
let history=[];
let score=0;
const boardEl=document.getElementById("board");
const gridEl=document.getElementById("grid");
const scoreEl=document.getElementById("score");

function saveGame(){
  localStorage.setItem("gameState",JSON.stringify({board,score,SIZE,TARGET}));
}
function loadGame(){
  const data=JSON.parse(localStorage.getItem("gameState")||"null");
  if(data){
    board=data.board;
    score=data.score;
    SIZE=data.SIZE;
    TARGET=data.TARGET;
    document.getElementById("sizeSelect").value=SIZE;
    document.getElementById("targetInput").value=TARGET;
    return true;
  }
  return false;
}

function initGrid(){
  gridEl.style.gridTemplateColumns=`repeat(${SIZE},1fr)`;
  gridEl.innerHTML="";
  for(let i=0;i<SIZE*SIZE;i++){
    const cell=document.createElement("div");
    cell.className="cell";
    gridEl.appendChild(cell);
  }
}

function emptyBoard(){
  board=Array.from({length:SIZE},()=>Array(SIZE).fill(0));
}

function spawn(){
  let empties=[];
  for(let r=0;r<SIZE;r++)
    for(let c=0;c<SIZE;c++)
      if(board[r][c]===0) empties.push([r,c]);
  if(!empties.length) return;
  let [r,c]=empties[Math.floor(Math.random()*empties.length)];
  board[r][c]=Math.random()<0.9?2:4;
}

function render(){
  scoreEl.textContent=score;
  document.querySelectorAll(".tile").forEach(e=>e.remove());
  const rect=gridEl.getBoundingClientRect();
  const cellSize=(rect.width-(SIZE-1)*10)/SIZE;
  for(let r=0;r<SIZE;r++){
    for(let c=0;c<SIZE;c++){
      if(board[r][c]){
        const tile=document.createElement("div");
        tile.className="tile";
        tile.textContent=board[r][c];
        tile.style.width=cellSize+"px";
        tile.style.height=cellSize+"px";
        tile.style.left=(c*(cellSize+10))+"px";
        tile.style.top=(r*(cellSize+10))+"px";
        boardEl.appendChild(tile);
      }
    }
  }
}

function move(dir){
  let rotated=0;
  let mat=JSON.parse(JSON.stringify(board));
  function rotate(m){
    return m[0].map((_,i)=>m.map(row=>row[i]).reverse());
  }
  if(dir==="up"){mat=rotate(mat);rotated=1;}
  if(dir==="right"){mat=rotate(rotate(mat));rotated=2;}
  if(dir==="down"){mat=rotate(rotate(rotate(mat)));rotated=3;}

  let moved=false;
  for(let r=0;r<SIZE;r++){
    let row=mat[r].filter(x=>x);
    for(let i=0;i<row.length-1;i++){
      if(row[i]===row[i+1]){
        row[i]*=2;
        score+=row[i];
        playMergeSound();
        row.splice(i+1,1);
      }
    }
    while(row.length<SIZE) row.push(0);
    if(row.toString()!==mat[r].toString()) moved=true;
    mat[r]=row;
  }
  for(let i=0;i<(4-rotated)%4;i++) mat=rotate(mat);
  if(moved){
    history.push(JSON.stringify({board,score}));
    board=mat;
    spawn();
    saveGame();
    render();
  }
}

function undo(){
  if(history.length){
    const prev=JSON.parse(history.pop());
    board=prev.board;
    score=prev.score;
    render();
  }
}

function playMergeSound(){
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const osc=ctx.createOscillator();
  const gain=ctx.createGain();
  osc.type="triangle";
  osc.frequency.value=440;
  gain.gain.value=0.1;
  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.start();
  osc.stop(ctx.currentTime+0.1);
}

function newGame(){
  history=[];
  emptyBoard();
  spawn();
  spawn();
  score=0;
  saveGame();
  render();
}

document.getElementById("restart").onclick=newGame;
document.getElementById("undo").onclick=undo;
document.getElementById("sizeSelect").onchange=e=>{
  SIZE=parseInt(e.target.value);
  initGrid();
  newGame();
};
document.getElementById("targetInput").onchange=e=>{
  TARGET=parseInt(e.target.value);
  saveGame();
};

window.addEventListener("keydown",e=>{
  if(e.key==="ArrowLeft") move("left");
  if(e.key==="ArrowRight") move("right");
  if(e.key==="ArrowUp") move("up");
  if(e.key==="ArrowDown") move("down");
});

if(!loadGame()){
  initGrid();
  newGame();
}else{
  initGrid();
  render();
}
</script>
</body>
</html>