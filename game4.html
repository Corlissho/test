<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>2048 Smooth Animation</title>

<style>
body{
  margin:0;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:linear-gradient(135deg,#667eea,#764ba2);
  font-family:sans-serif;
}

.game{
  width:420px;
}

.header{
  display:flex;
  justify-content:space-between;
  color:white;
  margin-bottom:15px;
}

.board{
  position:relative;
  background:rgba(255,255,255,0.15);
  padding:10px;
  border-radius:15px;
}

.grid{
  display:grid;
  gap:10px;
}

.cell{
  background:rgba(255,255,255,0.2);
  border-radius:10px;
  padding-bottom:100%;
  position:relative;
}

.tile{
  position:absolute;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  font-size:22px;
  background:white;
  transition:top .18s ease,left .18s ease;
}

.tile.merge{
  animation:pop .15s ease;
}

@keyframes pop{
  0%{transform:scale(1)}
  50%{transform:scale(1.2)}
  100%{transform:scale(1)}
}
</style>
</head>
<body>

<div class="game">
  <div class="header">
    <div>2048 Smooth</div>
    <div>Score: <span id="score">0</span></div>
  </div>

  <div class="board" id="board">
    <div class="grid" id="grid"></div>
  </div>
</div>

<script>

const SIZE = 4;
let board = [];
let score = 0;
let animating = false;

const boardEl = document.getElementById("board");
const gridEl = document.getElementById("grid");
const scoreEl = document.getElementById("score");

function init(){
  gridEl.style.gridTemplateColumns = `repeat(${SIZE},1fr)`;
  for(let i=0;i<SIZE*SIZE;i++){
    const cell = document.createElement("div");
    cell.className="cell";
    gridEl.appendChild(cell);
  }

  board = Array.from({length:SIZE},()=>Array(SIZE).fill(0));
  spawn();
  spawn();
  render(true);
}

function spawn(){
  let empties=[];
  for(let r=0;r<SIZE;r++)
    for(let c=0;c<SIZE;c++)
      if(board[r][c]===0) empties.push([r,c]);

  if(!empties.length) return;

  const [r,c] = empties[Math.floor(Math.random()*empties.length)];
  board[r][c] = Math.random()<0.9?2:4;
}

function render(initial=false){

  const gap = 10;
  const rect = gridEl.getBoundingClientRect();
  const cellSize = (rect.width - gap*(SIZE-1)) / SIZE;

  if(initial){
    boardEl.querySelectorAll(".tile").forEach(t=>t.remove());
  }

  for(let r=0;r<SIZE;r++){
    for(let c=0;c<SIZE;c++){
      if(board[r][c]!==0){
        let tile = document.querySelector(`.tile[data-r='${r}'][data-c='${c}']`);

        if(!tile){
          tile = document.createElement("div");
          tile.className="tile";
          tile.dataset.r=r;
          tile.dataset.c=c;
          tile.textContent=board[r][c];
          tile.style.width=cellSize+"px";
          tile.style.height=cellSize+"px";
          boardEl.appendChild(tile);
        }

        tile.style.left = (c*(cellSize+gap))+"px";
        tile.style.top  = (r*(cellSize+gap))+"px";
        tile.textContent = board[r][c];
      }
    }
  }

  scoreEl.textContent = score;
}

function move(direction){
  if(animating) return;

  const dirMap = {
    left:{x:0,y:-1},
    right:{x:0,y:1},
    up:{x:-1,y:0},
    down:{x:1,y:0}
  };

  const vector = dirMap[direction];
  let moved = false;
  const merged = Array.from({length:SIZE},()=>Array(SIZE).fill(false));

  const rows=[...Array(SIZE).keys()];
  const cols=[...Array(SIZE).keys()];

  if(vector.x===1) rows.reverse();
  if(vector.y===1) cols.reverse();

  animating=true;

  rows.forEach(r=>{
    cols.forEach(c=>{
      if(board[r][c]===0) return;

      let nr=r;
      let nc=c;

      while(true){
        let nextR=nr+vector.x;
        let nextC=nc+vector.y;

        if(nextR<0||nextR>=SIZE||nextC<0||nextC>=SIZE) break;

        if(board[nextR][nextC]===0){
          board[nextR][nextC]=board[nr][nc];
          board[nr][nc]=0;
          nr=nextR;
          nc=nextC;
          moved=true;
        }
        else if(board[nextR][nextC]===board[nr][nc]&&!merged[nextR][nextC]){
          board[nextR][nextC]*=2;
          board[nr][nc]=0;
          score+=board[nextR][nextC];
          merged[nextR][nextC]=true;
          moved=true;
          break;
        }
        else break;
      }
    });
  });

  if(moved){
    render();
    setTimeout(()=>{
      spawn();
      render();
      animating=false;
    },180);
  }else{
    animating=false;
  }
}

window.addEventListener("keydown",e=>{
  if(e.key==="ArrowLeft") move("left");
  if(e.key==="ArrowRight") move("right");
  if(e.key==="ArrowUp") move("up");
  if(e.key==="ArrowDown") move("down");
});

init();

</script>
</body>
</html>