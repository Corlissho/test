<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·‘è»Šè³½é“å°éŠæˆ²</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(to bottom, #1a1a2e, #16213e);
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            text-align: center;
        }
        
        header {
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            letter-spacing: 2px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #aaa;
            margin-bottom: 20px;
        }
        
        .game-container {
            position: relative;
            margin: 0 auto 30px;
            overflow: hidden;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
        }
        
        #gameCanvas {
            background-color: #0f3460;
            display: block;
            width: 100%;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 800px;
            margin-bottom: 30px;
        }
        
        .control-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            flex: 1;
            margin: 0 10px;
        }
        
        .control-panel h2 {
            color: #4FC3F7;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .key-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            max-width: 200px;
            margin: 0 auto;
        }
        
        .key {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #4FC3F7;
            border-radius: 8px;
            padding: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            user-select: none;
            transition: all 0.1s;
        }
        
        .key.active {
            background: #4FC3F7;
            transform: scale(0.95);
            box-shadow: 0 0 15px #4FC3F7;
        }
        
        .key-up {
            grid-column: 2;
            grid-row: 1;
        }
        
        .key-left {
            grid-column: 1;
            grid-row: 2;
        }
        
        .key-down {
            grid-column: 2;
            grid-row: 2;
        }
        
        .key-right {
            grid-column: 3;
            grid-row: 2;
        }
        
        .game-info {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .info-box {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px 25px;
            min-width: 180px;
            margin: 10px;
        }
        
        .info-title {
            color: #FFD700;
            font-size: 1rem;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 2rem;
            font-weight: bold;
            color: white;
        }
        
        .buttons {
            margin-top: 20px;
        }
        
        button {
            background: linear-gradient(to right, #FF416C, #FF4B2B);
            border: none;
            border-radius: 50px;
            color: white;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(255, 65, 108, 0.4);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 65, 108, 0.6);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            text-align: left;
            max-width: 800px;
        }
        
        .instructions h2 {
            color: #4FC3F7;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .instructions ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }
        
        .instructions li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .instructions p {
            color: #aaa;
            font-style: italic;
            text-align: center;
        }
        
        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            display: none;
        }
        
        .game-over h2 {
            font-size: 3.5rem;
            color: #FF416C;
            margin-bottom: 20px;
        }
        
        .game-over p {
            font-size: 1.5rem;
            margin-bottom: 30px;
        }
        
        .status-effects {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .status-effect {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 8px 15px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-effect-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        
        .shield-icon { background-color: #4CAF50; }
        .slow-icon { background-color: #FFC107; }
        .double-icon { background-color: #9C27B0; }
        .magnet-icon { background-color: #2196F3; }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .control-panel {
                margin: 10px 0;
            }
            
            .game-info {
                flex-direction: column;
                align-items: center;
            }
            
            .status-effects {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>æ¥µé€Ÿè³½é“</h1>
            <p class="subtitle">ä½¿ç”¨æ–¹å‘éµæ§åˆ¶è·‘è»Šï¼Œé¿å…æ’ä¸Šå…¶ä»–è»Šè¼›ï¼</p>
        </header>
        
        <div class="game-container">
            <canvas id="gameCanvas" width="800" height="600"></canvas>
            <div class="game-over" id="gameOverScreen">
                <h2>éŠæˆ²çµæŸï¼</h2>
                <p>ä½ çš„åˆ†æ•¸ï¼š<span id="finalScore">0</span></p>
                <button id="restartButton">é‡æ–°é–‹å§‹</button>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-panel">
                <h2>æ§åˆ¶éµ</h2>
                <div class="key-controls">
                    <div class="key key-up" id="keyUp">â†‘</div>
                    <div class="key key-left" id="keyLeft">â†</div>
                    <div class="key key-down" id="keyDown">â†“</div>
                    <div class="key key-right" id="keyRight">â†’</div>
                </div>
            </div>
            
            <div class="control-panel">
                <h2>éŠæˆ²ç‹€æ…‹</h2>
                <div class="game-info">
                    <div class="info-box">
                        <div class="info-title">åˆ†æ•¸</div>
                        <div class="info-value" id="score">0</div>
                    </div>
                    <div class="info-box">
                        <div class="info-title">é€Ÿåº¦</div>
                        <div class="info-value" id="speed">0 km/h</div>
                    </div>
                    <div class="info-box">
                        <div class="info-title">ç”Ÿå‘½å€¼</div>
                        <div class="info-value" id="lives">3</div>
                    </div>
                </div>
                
                <div class="status-effects" id="statusEffects">
                    <!-- ç‹€æ…‹æ•ˆæœå°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <div class="buttons">
            <button id="startButton">é–‹å§‹éŠæˆ²</button>
            <button id="pauseButton">æš«åœéŠæˆ²</button>
        </div>
        
        <div class="instructions">
            <h2>éŠæˆ²èªªæ˜</h2>
            <ul>
                <li>ä½¿ç”¨ <strong>â†‘ ä¸‹éµ</strong> åŠ é€Ÿ/æ¸›é€Ÿ</li>
                <li>ä½¿ç”¨ <strong>â† â†’ éµ</strong> åœ¨è³½é“é–“ç§»å‹•</li>
                <li>é¿é–‹å…¶ä»–è»Šè¼›ï¼Œæ’åˆ°æœƒæå¤±ç”Ÿå‘½å€¼</li>
                <li><strong>æ–°é“å…·ç³»çµ±ï¼š</strong></li>
                <li style="margin-left: 20px;">ğŸŸ¢ <strong>è­·ç›¾</strong>ï¼šç¶ è‰²åœ“åœˆï¼Œ3ç§’ç„¡æ•µ</li>
                <li style="margin-left: 20px;">ğŸŸ¡ <strong>æ¸›é€Ÿ</strong>ï¼šé»ƒè‰²åœ“åœˆï¼Œ5ç§’å…§æ‰€æœ‰æ•µè»Šæ¸›é€Ÿ</li>
                <li style="margin-left: 20px;">ğŸŸ£ <strong>åˆ†æ•¸åŠ å€</strong>ï¼šç´«è‰²æ˜Ÿæ˜Ÿï¼Œ30ç§’å…§åˆ†æ•¸åŠ å€</li>
                <li style="margin-left: 20px;">ğŸ”µ <strong>ç£éµ</strong>ï¼šè—è‰²ç£éµï¼Œè‡ªå‹•å¸å¼•é™„è¿‘é“å…·</li>
                <li>æ¯å®‰å…¨è¡Œé§›ä¸€æ®µè·é›¢å¯ä»¥ç²å¾—ç©åˆ†</li>
                <li>éŠæˆ²ç›®æ¨™ï¼šç²å¾—æœ€é«˜åˆ†æ•¸ï¼</li>
            </ul>
            <p>æ³¨æ„ï¼šè»Šé€Ÿè¶Šå¿«ï¼Œæ§åˆ¶è¶Šå›°é›£ï¼</p>
        </div>
    </div>

    <script>
        // éŠæˆ²è®Šæ•¸
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const speedElement = document.getElementById('speed');
        const livesElement = document.getElementById('lives');
        const startButton = document.getElementById('startButton');
        const pauseButton = document.getElementById('pauseButton');
        const restartButton = document.getElementById('restartButton');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const finalScoreElement = document.getElementById('finalScore');
        const statusEffectsElement = document.getElementById('statusEffects');
        
        // æ§åˆ¶éµå…ƒç´ 
        const keyUp = document.getElementById('keyUp');
        const keyDown = document.getElementById('keyDown');
        const keyLeft = document.getElementById('keyLeft');
        const keyRight = document.getElementById('keyRight');
        
        // éŠæˆ²ç‹€æ…‹
        let gameRunning = false;
        let gamePaused = false;
        let score = 0;
        let lives = 3;
        let speed = 0;
        let maxSpeed = 15;
        let acceleration = 0.2;
        let deceleration = 0.1;
        
        // é“å…·é¡å‹å®šç¾©
        const POWERUP_TYPES = {
            SHIELD: { 
                id: 'shield',
                name: 'è­·ç›¾', 
                color: '#4CAF50', 
                duration: 3000,
                icon: 'ğŸ›¡ï¸',
                drawFunction: drawShieldPowerUp
            },
            SLOW_ENEMY: { 
                id: 'slow',
                name: 'æ¸›é€Ÿ', 
                color: '#FFC107', 
                duration: 5000,
                icon: 'ğŸ¢',
                drawFunction: drawSlowPowerUp
            },
            DOUBLE_SCORE: { 
                id: 'double',
                name: 'åˆ†æ•¸åŠ å€', 
                color: '#9C27B0', 
                duration: 30000,
                icon: 'â­',
                drawFunction: drawDoubleScorePowerUp
            },
            MAGNET: { 
                id: 'magnet',
                name: 'ç£éµ', 
                color: '#2196F3', 
                duration: 10000,
                icon: 'ğŸ§²',
                drawFunction: drawMagnetPowerUp
            },
            SPEED_BOOST: { 
                id: 'speed',
                name: 'åŠ é€Ÿ', 
                color: '#FFD700', 
                duration: 3000,
                icon: 'âš¡',
                drawFunction: drawSpeedPowerUp
            }
        };
        
        // ç©å®¶ç‹€æ…‹æ•ˆæœ
        let playerEffects = {
            shield: { active: false, endTime: 0 },
            slowEnemy: { active: false, endTime: 0 },
            doubleScore: { active: false, endTime: 0 },
            magnet: { active: false, endTime: 0, range: 200 },
            speedBoost: { active: false, endTime: 0 }
        };
        
        // è³½é“è¨­å®š
        const trackCount = 3;
        const trackWidth = canvas.width / trackCount;
        const trackColors = ['#2E8B57', '#228B22', '#006400'];
        const laneMarkings = [];
        
        // åˆå§‹åŒ–è»Šé“æ¨™è¨˜
        for (let i = 1; i < trackCount; i++) {
            laneMarkings.push({
                x: i * trackWidth,
                y: 0,
                width: 10,
                height: 40,
                gap: 20
            });
        }
        
        // ç©å®¶è»Šè¼›
        const playerCar = {
            x: canvas.width / 2 - 25,
            y: canvas.height - 120,
            width: 50,
            height: 100,
            color: '#FF416C',
            track: 1, // 0, 1, 2
            speed: 0,
            maxSpeed: maxSpeed,
            acceleration: acceleration,
            deceleration: deceleration,
            isInvulnerable: false
        };
        
        // æ•µæ–¹è»Šè¼›é™£åˆ—
        let enemyCars = [];
        
        // é“å…·é™£åˆ—
        let powerUps = [];
        
        // æ§åˆ¶ç‹€æ…‹
        const keys = {
            ArrowUp: false,
            ArrowDown: false,
            ArrowLeft: false,
            ArrowRight: false
        };
        
        // åˆå§‹åŒ–éŠæˆ²
        function initGame() {
            score = 0;
            lives = 3;
            speed = 0;
            playerCar.x = canvas.width / 2 - 25;
            playerCar.y = canvas.height - 120;
            playerCar.track = 1;
            playerCar.speed = 0;
            playerCar.isInvulnerable = false;
            enemyCars = [];
            powerUps = [];
            
            // é‡ç½®æ‰€æœ‰æ•ˆæœ
            for (let effect in playerEffects) {
                playerEffects[effect].active = false;
                playerEffects[effect].endTime = 0;
            }
            
            gameOverScreen.style.display = 'none';
            updateUI();
            updateStatusEffects();
        }
        
        // ç¹ªè£½è³½é“
        function drawTracks() {
            // ç¹ªè£½è³½é“èƒŒæ™¯
            for (let i = 0; i < trackCount; i++) {
                ctx.fillStyle = trackColors[i];
                ctx.fillRect(i * trackWidth, 0, trackWidth, canvas.height);
                
                // è³½é“é‚Šç·£
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(i * trackWidth, 0, 5, canvas.height);
                ctx.fillRect((i + 1) * trackWidth - 5, 0, 5, canvas.height);
            }
            
            // ç¹ªè£½è»Šé“æ¨™è¨˜
            laneMarkings.forEach(marking => {
                for (let y = 0; y < canvas.height; y += marking.height + marking.gap) {
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(marking.x - marking.width/2, y, marking.width, marking.height);
                }
            });
            
            // ç¹ªè£½èƒŒæ™¯é å±±
            drawBackground();
        }
        
        // ç¹ªè£½èƒŒæ™¯
        function drawBackground() {
            // é è™•å±±è„ˆ
            ctx.fillStyle = 'rgba(15, 52, 96, 0.7)';
            ctx.beginPath();
            ctx.moveTo(0, 100);
            ctx.lineTo(150, 50);
            ctx.lineTo(300, 120);
            ctx.lineTo(500, 80);
            ctx.lineTo(700, 130);
            ctx.lineTo(800, 90);
            ctx.lineTo(800, 0);
            ctx.lineTo(0, 0);
            ctx.closePath();
            ctx.fill();
            
            // é›²æœµ
            ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            drawCloud(100, 60, 40);
            drawCloud(400, 40, 30);
            drawCloud(600, 80, 50);
        }
        
        // ç¹ªè£½é›²æœµ
        function drawCloud(x, y, size) {
            ctx.beginPath();
            ctx.arc(x, y, size, 0, Math.PI * 2);
            ctx.arc(x + size * 0.8, y - size * 0.3, size * 0.7, 0, Math.PI * 2);
            ctx.arc(x + size * 1.5, y, size * 0.8, 0, Math.PI * 2);
            ctx.arc(x + size * 0.8, y + size * 0.3, size * 0.7, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // ç¹ªè£½ç©å®¶è»Šè¼›
        function drawPlayerCar() {
            // å¦‚æœæœ‰è­·ç›¾æ•ˆæœï¼Œç¹ªè£½è­·ç›¾
            if (playerEffects.shield.active) {
                ctx.strokeStyle = '#4CAF50';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(
                    playerCar.x + playerCar.width/2,
                    playerCar.y + playerCar.height/2,
                    Math.max(playerCar.width, playerCar.height)/2 + 15,
                    0, Math.PI * 2
                );
                ctx.stroke();
                
                // è­·ç›¾è„ˆè¡æ•ˆæœ
                const pulse = (Date.now() % 1000) / 1000;
                ctx.globalAlpha = 0.3 + 0.2 * Math.sin(pulse * Math.PI * 2);
                ctx.fillStyle = '#4CAF50';
                ctx.beginPath();
                ctx.arc(
                    playerCar.x + playerCar.width/2,
                    playerCar.y + playerCar.height/2,
                    Math.max(playerCar.width, playerCar.height)/2 + 10,
                    0, Math.PI * 2
                );
                ctx.fill();
                ctx.globalAlpha = 1.0;
            }
            
            // è»Šèº«
            ctx.fillStyle = playerCar.color;
            ctx.fillRect(playerCar.x, playerCar.y, playerCar.width, playerCar.height);
            
            // å¦‚æœæœ‰ç£éµæ•ˆæœï¼Œç¹ªè£½ç£åŠ›ç¯„åœ
            if (playerEffects.magnet.active) {
                ctx.strokeStyle = '#2196F3';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.arc(
                    playerCar.x + playerCar.width/2,
                    playerCar.y + playerCar.height/2,
                    playerEffects.magnet.range,
                    0, Math.PI * 2
                );
                ctx.stroke();
                ctx.setLineDash([]);
            }
            
            // è»Šçª—
            ctx.fillStyle = '#4FC3F7';
            ctx.fillRect(playerCar.x + 5, playerCar.y + 10, playerCar.width - 10, 30);
            
            // è»Šç‡ˆ
            ctx.fillStyle = '#FFD700';
            ctx.fillRect(playerCar.x + 5, playerCar.y + playerCar.height - 15, 10, 10);
            ctx.fillRect(playerCar.x + playerCar.width - 15, playerCar.y + playerCar.height - 15, 10, 10);
            
            // è¼ªèƒ
            ctx.fillStyle = '#222';
            ctx.fillRect(playerCar.x - 5, playerCar.y + 15, 5, 25);
            ctx.fillRect(playerCar.x + playerCar.width, playerCar.y + 15, 5, 25);
            ctx.fillRect(playerCar.x - 5, playerCar.y + playerCar.height - 40, 5, 25);
            ctx.fillRect(playerCar.x + playerCar.width, playerCar.y + playerCar.height - 40, 5, 25);
        }
        
        // ç¹ªè£½æ•µæ–¹è»Šè¼›
        function drawEnemyCars() {
            enemyCars.forEach(car => {
                // å¦‚æœæœ‰æ¸›é€Ÿæ•ˆæœï¼Œæ”¹è®Šè»Šè¼›é¡è‰²
                if (playerEffects.slowEnemy.active) {
                    ctx.fillStyle = '#666'; // è®Šç°è¡¨ç¤ºæ¸›é€Ÿ
                } else {
                    ctx.fillStyle = car.color;
                }
                
                ctx.fillRect(car.x, car.y, car.width, car.height);
                
                // è»Šçª—
                ctx.fillStyle = '#999';
                ctx.fillRect(car.x + 5, car.y + 10, car.width - 10, 20);
                
                // è¼ªèƒ
                ctx.fillStyle = '#222';
                ctx.fillRect(car.x - 5, car.y + 15, 5, 20);
                ctx.fillRect(car.x + car.width, car.y + 15, 5, 20);
                ctx.fillRect(car.x - 5, car.y + car.height - 35, 5, 20);
                ctx.fillRect(car.x + car.width, car.y + car.height - 35, 5, 20);
            });
        }
        
        // ç¹ªè£½è­·ç›¾é“å…·
        function drawShieldPowerUp(x, y, size) {
            // å¤–åœˆ
            ctx.strokeStyle = '#4CAF50';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(x + size/2, y + size/2, size/2, 0, Math.PI * 2);
            ctx.stroke();
            
            // å…§åœˆ
            ctx.fillStyle = '#4CAF50';
            ctx.beginPath();
            ctx.arc(x + size/2, y + size/2, size/3, 0, Math.PI * 2);
            ctx.fill();
            
            // è­·ç›¾åœ–æ¨™
            ctx.fillStyle = '#FFFFFF';
            ctx.beginPath();
            // ç¹ªè£½ç°¡å–®çš„ç›¾ç‰Œå½¢ç‹€
            ctx.moveTo(x + size/2, y + size/4);
            ctx.lineTo(x + size/4, y + size/2);
            ctx.lineTo(x + size/2, y + size*3/4);
            ctx.lineTo(x + size*3/4, y + size/2);
            ctx.closePath();
            ctx.fill();
        }
        
        // ç¹ªè£½æ¸›é€Ÿé“å…·
        function drawSlowPowerUp(x, y, size) {
            // é»ƒè‰²åœ“åœˆ
            ctx.fillStyle = '#FFC107';
            ctx.beginPath();
            ctx.arc(x + size/2, y + size/2, size/2, 0, Math.PI * 2);
            ctx.fill();
            
            // çƒé¾œåœ–æ¨™
            ctx.fillStyle = '#795548';
            // çƒé¾œèº«é«”
            ctx.beginPath();
            ctx.ellipse(x + size/2, y + size/2, size/3, size/4, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // çƒé¾œé ­
            ctx.beginPath();
            ctx.arc(x + size/2, y + size/3, size/8, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // ç¹ªè£½åˆ†æ•¸åŠ å€é“å…·
        function drawDoubleScorePowerUp(x, y, size) {
            // ç´«è‰²æ˜Ÿæ˜ŸèƒŒæ™¯
            ctx.fillStyle = '#9C27B0';
            ctx.beginPath();
            ctx.arc(x + size/2, y + size/2, size/2, 0, Math.PI * 2);
            ctx.fill();
            
            // æ˜Ÿæ˜Ÿ
            ctx.fillStyle = '#FFFFFF';
            drawStar(ctx, x + size/2, y + size/2, 5, size/4, size/8);
        }
        
        // ç¹ªè£½ç£éµé“å…·
        function drawMagnetPowerUp(x, y, size) {
            // è—è‰²èƒŒæ™¯
            ctx.fillStyle = '#2196F3';
            ctx.beginPath();
            ctx.arc(x + size/2, y + size/2, size/2, 0, Math.PI * 2);
            ctx.fill();
            
            // ç£éµåœ–æ¨™
            ctx.fillStyle = '#FFFFFF';
            // ç£éµçš„Uå½¢
            ctx.beginPath();
            ctx.arc(x + size/2, y + size/2, size/3, Math.PI * 0.25, Math.PI * 0.75);
            ctx.arc(x + size/2, y + size/2, size/3, Math.PI * 1.25, Math.PI * 1.75);
            ctx.closePath();
            ctx.fill();
        }
        
        // ç¹ªè£½åŠ é€Ÿé“å…·ï¼ˆåŸæœ‰çš„ï¼‰
        function drawSpeedPowerUp(x, y, size) {
            // é“å…·å¤–æ¡†
            ctx.fillStyle = '#4FC3F7';
            ctx.beginPath();
            ctx.arc(x + size/2, y + size/2, size/2 + 2, 0, Math.PI * 2);
            ctx.fill();
            
            // é“å…·å…§éƒ¨
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(x + size/2, y + size/2, size/2 - 2, 0, Math.PI * 2);
            ctx.fill();
            
            // é–ƒé›»åœ–æ¨™
            ctx.fillStyle = '#4FC3F7';
            ctx.beginPath();
            ctx.moveTo(x + size/2, y + size/3);
            ctx.lineTo(x + size/3, y + size/2);
            ctx.lineTo(x + size/2, y + size/2);
            ctx.lineTo(x + size/1.5, y + size/1.5);
            ctx.lineTo(x + size/2, y + size/1.5);
            ctx.lineTo(x + size/1.5, y + size/3);
            ctx.closePath();
            ctx.fill();
        }
        
        // ç¹ªè£½æ˜Ÿæ˜Ÿçš„è¼”åŠ©å‡½æ•¸
        function drawStar(ctx, cx, cy, spikes, outerRadius, innerRadius) {
            let rot = Math.PI / 2 * 3;
            let x = cx;
            let y = cy;
            let step = Math.PI / spikes;
            
            ctx.beginPath();
            ctx.moveTo(cx, cy - outerRadius);
            
            for (let i = 0; i < spikes; i++) {
                x = cx + Math.cos(rot) * outerRadius;
                y = cy + Math.sin(rot) * outerRadius;
                ctx.lineTo(x, y);
                rot += step;
                
                x = cx + Math.cos(rot) * innerRadius;
                y = cy + Math.sin(rot) * innerRadius;
                ctx.lineTo(x, y);
                rot += step;
            }
            
            ctx.lineTo(cx, cy - outerRadius);
            ctx.closePath();
            ctx.fill();
        }
        
        // ç¹ªè£½æ‰€æœ‰é“å…·
        function drawPowerUps() {
            powerUps.forEach(powerUp => {
                const powerUpType = POWERUP_TYPES[powerUp.type];
                if (powerUpType && powerUpType.drawFunction) {
                    powerUpType.drawFunction(powerUp.x, powerUp.y, powerUp.size);
                }
            });
        }
        
        // ç”Ÿæˆæ•µæ–¹è»Šè¼›
        function generateEnemyCar() {
            const track = Math.floor(Math.random() * trackCount);
            const x = track * trackWidth + (trackWidth - 50) / 2;
            const y = -100;
            const colors = ['#FF9800', '#9C27B0', '#2196F3', '#F44336'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            let enemySpeed = 3 + Math.random() * 5;
            
            // å¦‚æœæœ‰æ¸›é€Ÿæ•ˆæœï¼Œé™ä½æ•µè»Šé€Ÿåº¦
            if (playerEffects.slowEnemy.active) {
                enemySpeed *= 0.5; // æ¸›åŠé€Ÿåº¦
            }
            
            enemyCars.push({
                x: x,
                y: y,
                width: 50,
                height: 100,
                color: color,
                track: track,
                speed: enemySpeed
            });
        }
        
        // ç”Ÿæˆé“å…·
        function generatePowerUp() {
            if (Math.random() < 0.015) { // 1.5% æ©Ÿç‡ç”Ÿæˆé“å…·
                const track = Math.floor(Math.random() * trackCount);
                const x = track * trackWidth + (trackWidth - 30) / 2;
                const y = -30;
                
                // éš¨æ©Ÿé¸æ“‡é“å…·é¡å‹
                const powerUpTypes = Object.keys(POWERUP_TYPES);
                const randomType = powerUpTypes[Math.floor(Math.random() * powerUpTypes.length)];
                
                powerUps.push({
                    x: x,
                    y: y,
                    size: 30,
                    track: track,
                    type: randomType
                });
            }
        }
        
        // æ›´æ–°æ•µæ–¹è»Šè¼›ä½ç½®
        function updateEnemyCars() {
            for (let i = enemyCars.length - 1; i >= 0; i--) {
                enemyCars[i].y += enemyCars[i].speed;
                
                // ç§»é™¤è¶…å‡ºç•«å¸ƒçš„è»Šè¼›
                if (enemyCars[i].y > canvas.height) {
                    enemyCars.splice(i, 1);
                    // åŸºç¤åˆ†æ•¸
                    let points = 10;
                    // å¦‚æœæœ‰åˆ†æ•¸åŠ å€æ•ˆæœ
                    if (playerEffects.doubleScore.active) {
                        points *= 2;
                    }
                    score += points;
                }
            }
        }
        
        // æ›´æ–°é“å…·ä½ç½®
        function updatePowerUps() {
            for (let i = powerUps.length - 1; i >= 0; i--) {
                const powerUp = powerUps[i];
                
                // å¦‚æœæœ‰ç£éµæ•ˆæœä¸”é“å…·åœ¨ç¯„åœå…§ï¼Œå‘ç©å®¶ç§»å‹•
                if (playerEffects.magnet.active) {
                    const dx = (playerCar.x + playerCar.width/2) - (powerUp.x + powerUp.size/2);
                    const dy = (playerCar.y + playerCar.height/2) - (powerUp.y + powerUp.size/2);
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < playerEffects.magnet.range) {
                        // å‘ç©å®¶ç§»å‹•
                        const speed = 8;
                        powerUp.x += (dx / distance) * speed;
                        powerUp.y += (dy / distance) * speed;
                    } else {
                        powerUp.y += 5;
                    }
                } else {
                    powerUp.y += 5;
                }
                
                // ç§»é™¤è¶…å‡ºç•«å¸ƒçš„é“å…·
                if (powerUp.y > canvas.height) {
                    powerUps.splice(i, 1);
                }
            }
        }
        
        // æª¢æ¸¬ç¢°æ’
        function checkCollisions() {
            // æª¢æ¸¬èˆ‡æ•µæ–¹è»Šè¼›çš„ç¢°æ’
            for (let i = enemyCars.length - 1; i >= 0; i--) {
                const car = enemyCars[i];
                if (
                    playerCar.x < car.x + car.width &&
                    playerCar.x + playerCar.width > car.x &&
                    playerCar.y < car.y + car.height &&
                    playerCar.y + playerCar.height > car.y
                ) {
                    // å¦‚æœæœ‰è­·ç›¾æ•ˆæœï¼Œä¸æå¤±ç”Ÿå‘½å€¼
                    if (playerEffects.shield.active) {
                        enemyCars.splice(i, 1);
                        score += 20; // æ‘§æ¯€æ•µè»Šçå‹µ
                    } else {
                        // ç¢°æ’ç™¼ç”Ÿ
                        enemyCars.splice(i, 1);
                        lives--;
                        updateUI();
                        
                        // å¦‚æœç”Ÿå‘½å€¼è€—ç›¡ï¼ŒéŠæˆ²çµæŸ
                        if (lives <= 0) {
                            endGame();
                        }
                    }
                    return;
                }
            }
            
            // æª¢æ¸¬èˆ‡é“å…·çš„ç¢°æ’
            for (let i = powerUps.length - 1; i >= 0; i--) {
                const powerUp = powerUps[i];
                if (
                    playerCar.x < powerUp.x + powerUp.size &&
                    playerCar.x + playerCar.width > powerUp.x &&
                    playerCar.y < powerUp.y + powerUp.size &&
                    playerCar.y + playerCar.height > powerUp.y
                ) {
                    // æ”¶é›†é“å…·
                    const powerUpType = POWERUP_TYPES[powerUp.type];
                    powerUps.splice(i, 1);
                    
                    // æ ¹æ“šé“å…·é¡å‹æ‡‰ç”¨æ•ˆæœ
                    applyPowerUpEffect(powerUpType);
                    updateUI();
                }
            }
        }
        
        // æ‡‰ç”¨é“å…·æ•ˆæœ
        function applyPowerUpEffect(powerUpType) {
            if (!powerUpType) return;
            
            const now = Date.now();
            const endTime = now + powerUpType.duration;
            
            // æ ¹æ“šé“å…·é¡å‹è¨­ç½®æ•ˆæœ
            switch(powerUpType.id) {
                case 'shield':
                    playerEffects.shield.active = true;
                    playerEffects.shield.endTime = endTime;
                    playerCar.isInvulnerable = true;
                    break;
                    
                case 'slow':
                    playerEffects.slowEnemy.active = true;
                    playerEffects.slowEnemy.endTime = endTime;
                    break;
                    
                case 'double':
                    playerEffects.doubleScore.active = true;
                    playerEffects.doubleScore.endTime = endTime;
                    break;
                    
                case 'magnet':
                    playerEffects.magnet.active = true;
                    playerEffects.magnet.endTime = endTime;
                    break;
                    
                case 'speed':
                    playerEffects.speedBoost.active = true;
                    playerEffects.speedBoost.endTime = endTime;
                    playerCar.maxSpeed = 20;
                    break;
            }
            
            // æ›´æ–°ç‹€æ…‹æ•ˆæœé¡¯ç¤º
            updateStatusEffects();
            
            // è¨­ç½®å®šæ™‚å™¨ç§»é™¤æ•ˆæœ
            setTimeout(() => {
                removePowerUpEffect(powerUpType.id);
            }, powerUpType.duration);
        }
        
        // ç§»é™¤é“å…·æ•ˆæœ
        function removePowerUpEffect(effectId) {
            switch(effectId) {
                case 'shield':
                    playerEffects.shield.active = false;
                    playerCar.isInvulnerable = false;
                    break;
                    
                case 'slow':
                    playerEffects.slowEnemy.active = false;
                    break;
                    
                case 'double':
                    playerEffects.doubleScore.active = false;
                    break;
                    
                case 'magnet':
                    playerEffects.magnet.active = false;
                    break;
                    
                case 'speed':
                    playerEffects.speedBoost.active = false;
                    playerCar.maxSpeed = maxSpeed;
                    break;
            }
            
            updateStatusEffects();
        }
        
        // æª¢æŸ¥æ•ˆæœæ˜¯å¦éæœŸ
        function checkEffectsExpiry() {
            const now = Date.now();
            
            for (let effect in playerEffects) {
                if (playerEffects[effect].active && now > playerEffects[effect].endTime) {
                    removePowerUpEffect(effect);
                }
            }
        }
        
        // æ›´æ–°ç©å®¶è»Šè¼›ä½ç½® - ä¿®æ­£è»Šé“åˆ‡æ›éŒ¯èª¤
        function updatePlayerCar() {
            // åŠ é€Ÿ/æ¸›é€Ÿ
            if (keys.ArrowUp && playerCar.speed < playerCar.maxSpeed) {
                playerCar.speed += playerCar.acceleration;
            } else if (keys.ArrowDown && playerCar.speed > 0) {
                playerCar.speed -= playerCar.deceleration * 2;
            } else if (playerCar.speed > 0) {
                playerCar.speed -= playerCar.deceleration;
            } else if (playerCar.speed < 0) {
                playerCar.speed = 0;
            }
            
            // ä¿®æ­£ï¼šå…è¨±åœ¨ä»»ä½•è»Šé“ä¹‹é–“åˆ‡æ›
            // æŒ‰å·¦éµä¸”ä¸åœ¨æœ€å·¦è»Šé“æ™‚ï¼Œå‘å·¦ç§»å‹•
            if (keys.ArrowLeft && playerCar.track > 0) {
                playerCar.track--;
                playerCar.x = playerCar.track * trackWidth + (trackWidth - playerCar.width) / 2;
                keys.ArrowLeft = false; // é˜²æ­¢é€£çºŒåˆ‡æ›
            }
            // æŒ‰å³éµä¸”ä¸åœ¨æœ€å³è»Šé“æ™‚ï¼Œå‘å³ç§»å‹•
            else if (keys.ArrowRight && playerCar.track < trackCount - 1) {
                playerCar.track++;
                playerCar.x = playerCar.track * trackWidth + (trackWidth - playerCar.width) / 2;
                keys.ArrowRight = false; // é˜²æ­¢é€£çºŒåˆ‡æ›
            }
            
            // æ›´æ–°é€Ÿåº¦é¡¯ç¤º
            speed = Math.round(playerCar.speed * 10);
        }
        
        // æ›´æ–°UI
        function updateUI() {
            scoreElement.textContent = score;
            speedElement.textContent = speed + ' km/h';
            livesElement.textContent = lives;
        }
        
        // æ›´æ–°ç‹€æ…‹æ•ˆæœé¡¯ç¤º
        function updateStatusEffects() {
            statusEffectsElement.innerHTML = '';
            
            for (let effectKey in playerEffects) {
                const effect = playerEffects[effectKey];
                if (effect.active && POWERUP_TYPES[effectKey]) {
                    const powerUpType = POWERUP_TYPES[effectKey];
                    const timeLeft = Math.max(0, Math.ceil((effect.endTime - Date.now()) / 1000));
                    
                    const effectElement = document.createElement('div');
                    effectElement.className = 'status-effect';
                    effectElement.innerHTML = `
                        <div class="status-effect-icon ${effectKey}-icon"></div>
                        <span>${powerUpType.icon} ${powerUpType.name}: ${timeLeft}s</span>
                    `;
                    statusEffectsElement.appendChild(effectElement);
                }
            }
        }
        
        // çµæŸéŠæˆ²
        function endGame() {
            gameRunning = false;
            finalScoreElement.textContent = score;
            gameOverScreen.style.display = 'flex';
        }
        
        // éŠæˆ²ä¸»å¾ªç’°
        function gameLoop() {
            if (!gameRunning || gamePaused) return;
            
            // æ¸…é™¤ç•«å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç¹ªè£½è³½é“
            drawTracks();
            
            // æª¢æŸ¥æ•ˆæœæ˜¯å¦éæœŸ
            checkEffectsExpiry();
            
            // æ›´æ–°å’Œç¹ªè£½æ•µæ–¹è»Šè¼›
            updateEnemyCars();
            drawEnemyCars();
            
            // æ›´æ–°å’Œç¹ªè£½é“å…·
            updatePowerUps();
            drawPowerUps();
            
            // æ›´æ–°ç©å®¶è»Šè¼›
            updatePlayerCar();
            drawPlayerCar();
            
            // æª¢æ¸¬ç¢°æ’
            checkCollisions();
            
            // éš¨æ©Ÿç”Ÿæˆæ•µæ–¹è»Šè¼›
            if (Math.random() < 0.03) {
                generateEnemyCar();
            }
            
            // éš¨æ©Ÿç”Ÿæˆé“å…·
            generatePowerUp();
            
            // æ›´æ–°UI
            updateUI();
            
            // å®šæœŸæ›´æ–°ç‹€æ…‹æ•ˆæœé¡¯ç¤ºï¼ˆæ¯ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
            if (Date.now() % 1000 < 16) { // å¤§ç´„æ¯ç§’æ›´æ–°ä¸€æ¬¡
                updateStatusEffects();
            }
            
            // è«‹æ±‚ä¸‹ä¸€å¹€
            requestAnimationFrame(gameLoop);
        }
        
        // äº‹ä»¶ç›£è½
        document.addEventListener('keydown', (e) => {
            if (keys.hasOwnProperty(e.key)) {
                keys[e.key] = true;
                
                // é«˜äº®é¡¯ç¤ºæŒ‰ä¸‹çš„éµ
                switch(e.key) {
                    case 'ArrowUp':
                        keyUp.classList.add('active');
                        break;
                    case 'ArrowDown':
                        keyDown.classList.add('active');
                        break;
                    case 'ArrowLeft':
                        keyLeft.classList.add('active');
                        break;
                    case 'ArrowRight':
                        keyRight.classList.add('active');
                        break;
                }
            }
        });
        
        document.addEventListener('keyup', (e) => {
            if (keys.hasOwnProperty(e.key)) {
                keys[e.key] = false;
                
                // ç§»é™¤é«˜äº®
                switch(e.key) {
                    case 'ArrowUp':
                        keyUp.classList.remove('active');
                        break;
                    case 'ArrowDown':
                        keyDown.classList.remove('active');
                        break;
                    case 'ArrowLeft':
                        keyLeft.classList.remove('active');
                        break;
                    case 'ArrowRight':
                        keyRight.classList.remove('active');
                        break;
                }
            }
        });
        
        // è§¸æ§æ§åˆ¶ï¼ˆç”¨æ–¼ç§»å‹•è¨­å‚™ï¼‰
        let touchStartX = 0;
        let touchStartY = 0;
        let lastLaneChangeTime = 0;
        const laneChangeCooldown = 200; // 200æ¯«ç§’å†·å»æ™‚é–“é˜²æ­¢é€£çºŒåˆ‡æ›
        
        document.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            e.preventDefault();
        });
        
        document.addEventListener('touchmove', (e) => {
            if (!gameRunning || gamePaused) return;
            
            const touchX = e.touches[0].clientX;
            const touchY = e.touches[0].clientY;
            const deltaX = touchX - touchStartX;
            const deltaY = touchY - touchStartY;
            
            const now = Date.now();
            
            // æ°´å¹³ç§»å‹• - ä¿®æ­£è»Šé“åˆ‡æ›
            if (Math.abs(deltaX) > 30 && now - lastLaneChangeTime > laneChangeCooldown) {
                if (deltaX > 0 && playerCar.track < trackCount - 1) {
                    playerCar.track++;
                    playerCar.x = playerCar.track * trackWidth + (trackWidth - playerCar.width) / 2;
                    touchStartX = touchX;
                    lastLaneChangeTime = now;
                } else if (deltaX < 0 && playerCar.track > 0) {
                    playerCar.track--;
                    playerCar.x = playerCar.track * trackWidth + (trackWidth - playerCar.width) / 2;
                    touchStartX = touchX;
                    lastLaneChangeTime = now;
                }
            }
            
            // å‚ç›´ç§»å‹•ï¼ˆåŠ é€Ÿ/æ¸›é€Ÿï¼‰
            if (Math.abs(deltaY) > 20) {
                if (deltaY > 0 && playerCar.speed > 0) {
                    playerCar.speed -= playerCar.deceleration * 3;
                    touchStartY = touchY;
                } else if (deltaY < 0 && playerCar.speed < playerCar.maxSpeed) {
                    playerCar.speed += playerCar.acceleration * 2;
                    touchStartY = touchY;
                }
            }
            
            e.preventDefault();
        });
        
        // æŒ‰éˆ•äº‹ä»¶
        startButton.addEventListener('click', () => {
            if (!gameRunning) {
                initGame();
                gameRunning = true;
                gamePaused = false;
                gameLoop();
                startButton.textContent = 'é‡æ–°é–‹å§‹';
            } else {
                initGame();
                gameRunning = true;
                gamePaused = false;
                gameLoop();
            }
        });
        
        pauseButton.addEventListener('click', () => {
            if (gameRunning) {
                gamePaused = !gamePaused;
                pauseButton.textContent = gamePaused ? 'ç¹¼çºŒéŠæˆ²' : 'æš«åœéŠæˆ²';
                
                if (!gamePaused) {
                    gameLoop();
                }
            }
        });
        
        restartButton.addEventListener('click', () => {
            initGame();
            gameRunning = true;
            gamePaused = false;
            gameLoop();
            gameOverScreen.style.display = 'none';
        });
        
        // åˆå§‹ç¹ªè£½
        drawTracks();
        drawPlayerCar();
        updateUI();
        updateStatusEffects();
    </script>
</body>
</html>